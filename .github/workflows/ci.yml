name: Collider CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    name: Health Check & Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -e .
          pip install tree-sitter tree-sitter-python
      
      - name: Run Health Check
        run: |
          python3 -c "
          from core.newman_suite import NewmanSuite
          results = NewmanSuite().run_all()
          failed = [r for r in results if r.status == 'FAIL']
          if failed:
              for r in failed:
                  print(f'FAIL: {r.component} - {r.error}')
              exit(1)
          print('✅ Health check passed')
          "
      
      - name: Self-Analysis
        run: |
          python3 cli.py analyze . --output ci_output 2>&1 | tail -20
      
      - name: Verify Coverage
        run: |
          python3 -c "
          import json
          from pathlib import Path
          
          output = Path('ci_output/unified_analysis.json')
          if not output.exists():
              print('❌ Output not found')
              exit(1)
              
          data = json.loads(output.read_text())
          nodes = data.get('nodes', [])
          unknown = sum(1 for n in nodes if n.get('role') == 'Unknown')
          total = len(nodes)
          
          if total == 0:
              print('❌ No nodes found')
              exit(1)
              
          coverage = (total - unknown) / total * 100
          print(f'Coverage: {coverage:.1f}% ({total - unknown}/{total} nodes)')
          
          if coverage < 99.0:
              print('❌ Coverage below 99% threshold')
              exit(1)
          
          print('✅ Coverage check passed')
          "
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collider-analysis
          path: |
            ci_output/
            proof_output.json
          retention-days: 7
