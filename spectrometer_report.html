<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spectrometer - System Architecture Visualization</title>
  <!-- Robust Script Loading -->
  <script>
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function initVis() {
      try {
        await loadScript('assets/vis-network.min.js');
        console.log('Loaded vis-network from local assets');
      } catch (e1) {
        console.warn('Local asset failed, trying CDN...');
        try {
          await loadScript('https://unpkg.com/vis-network/standalone/umd/vis-network.min.js');
          console.log('Loaded vis-network from CDN');
        } catch (e2) {
          document.body.innerHTML = '<h1 style="color:red;padding:20px">Failed to load Visualization Library</h1><p>Please ensure assets/vis-network.min.js exists or you have internet access.</p>';
        }
      }
    }

    // Start loading immediately
    window.visPromise = initVis();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: rgba(255, 255, 255, 0.03);
      --border: rgba(255, 255, 255, 0.08);
      --text-primary: #ffffff;
      --text-secondary: #8b8b9e;
      --accent-cyan: #00d4ff;
      --accent-purple: #a855f7;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --accent-yellow: #eab308;
      --accent-orange: #f97316;
      --accent-pink: #ec4899;
      --glow-cyan: 0 0 30px rgba(0, 212, 255, 0.3);
      --glow-purple: 0 0 30px rgba(168, 85, 247, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      overflow: hidden;
    }

    /* Main Layout */
    .app {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.25rem;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-controls {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent-cyan);
    }

    .btn.active {
      background: var(--accent-cyan);
      color: #000;
      border-color: var(--accent-cyan);
    }

    /* Left Sidebar */
    .sidebar-left {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
    }

    /* Search */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.875rem;
      outline: none;
      transition: all 0.2s;
    }

    .search-box input:focus {
      border-color: var(--accent-cyan);
      box-shadow: var(--glow-cyan);
    }

    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* Layer Filters */
    .section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      margin-top: 20px;
    }

    .filter-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .filter-item.active {
      border-color: var(--accent-cyan);
    }

    .filter-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .filter-label {
      flex: 1;
      font-size: 0.875rem;
    }

    .filter-count {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-primary);
      padding: 2px 8px;
      border-radius: 10px;
    }

    /* Graph Container */
    .graph-container {
      position: relative;
      background: var(--bg-primary);
      background-image:
        radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #graph {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      outline: none;
    }

    /* Layout Controls */
    .layout-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      background: var(--bg-secondary);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      z-index: 10;
    }

    .layout-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .layout-btn:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .layout-btn.active {
      background: var(--accent-purple);
      color: white;
    }

    /* Right Sidebar - Node Details */
    .sidebar-right {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
    }

    .node-detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .node-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .node-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .node-subtitle {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Dimension Cards */
    .dimension-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .dimension-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }

    .dimension-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .dimension-value {
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Connections List */
    .connection-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .connection-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .connection-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-cyan);
    }

    .connection-arrow {
      color: var(--accent-cyan);
    }

    .connection-type {
      font-size: 0.7rem;
      color: var(--text-secondary);
      background: var(--bg-primary);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Animations */
    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>

<body>
  <div id="debug-console"
    style="position:fixed;bottom:0;left:0;width:100%;height:150px;background:rgba(0,0,0,0.85);color:#0f0;font-family:monospace;font-size:12px;overflow-y:auto;z-index:9999;padding:10px;pointer-events:none;display:none;">
    <div style="border-bottom:1px solid #333;margin-bottom:5px">Debug Console (Auto-shows on error)</div>
  </div>
  <script>
    function logToScreen(msg, type = 'info') {
      const consoleDiv = document.getElementById('debug-console');
      if (!consoleDiv) return;

      const line = document.createElement('div');
      line.style.color = type === 'error' ? '#ff5555' : type === 'warning' ? '#ffb86c' : '#50fa7b';
      line.style.marginBottom = '2px';
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      consoleDiv.appendChild(line);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;

      if (type === 'error' || type === 'warning') {
        consoleDiv.style.display = 'block';
        consoleDiv.style.pointerEvents = 'auto';
      }
    }

    // Capture global crashes
    window.onerror = function (msg, url, line, col, error) {
      if (msg.includes('ResizeObserver loop')) return false; // Ignore benign browser error
      logToScreen(`Global Error: ${msg} at line ${line}:${col}`, 'error');
      return false;
    };

    // Capture unhandled rejections
    window.onunhandledrejection = function (event) {
      logToScreen(`Unhandled Rejection: ${event.reason}`, 'error');
    };
  </script>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üî¨</div>
        <span class="logo-text">Spectrometer Pro</span>
      </div>
      <div class="header-controls">
        <button class="btn" onclick="fitGraph()">‚ä° Fit</button>
        <button class="btn" onclick="togglePhysics()">‚ö° Physics</button>
        <button class="btn" onclick="exportJSON()">üíæ Export</button>
      </div>
    </header>

    <!-- Left Sidebar -->
    <aside class="sidebar-left">
      <div class="search-box">
        <input type="text" id="search" placeholder="Search particles..." oninput="searchNodes(this.value)">
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-nodes">0</div>
          <div class="stat-label">Particles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-edges">0</div>
          <div class="stat-label">Edges</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-layers">0</div>
          <div class="stat-label">Layers</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-density">0%</div>
          <div class="stat-label">Density</div>
        </div>
      </div>

      <div class="section-title">Filter by Layer</div>
      <div class="filter-list" id="layer-filters"></div>

      <div class="section-title">Filter by Role</div>
      <div class="filter-list" id="role-filters"></div>
    </aside>

    <!-- Main Graph -->
    <main class="graph-container">
      <div id="graph"></div>
      <div class="layout-controls">
        <button class="layout-btn active" onclick="setLayout('force')">üåê Force</button>
        <button class="layout-btn" onclick="setLayout('hierarchical')">üìä Hierarchical</button>
        <button class="layout-btn" onclick="setLayout('radial')">üéØ Radial</button>
        <button class="layout-btn" onclick="setLayout('grid')">‚äû Grid</button>
      </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
      <div id="node-details">
        <div class="empty-state">
          <div class="empty-icon">üëÜ</div>
          <p>Click a node to see details</p>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ==========================================
    // SPECTROMETER DATA MODEL
    // ==========================================

    const layerColors = {
      'presentation': { bg: '#00d4ff', border: '#00a8cc', icon: 'üåê' },
      'application': { bg: '#a855f7', border: '#7c3aed', icon: 'üì±' },
      'domain': { bg: '#ec4899', border: '#db2777', icon: 'üíé' },
      'infrastructure': { bg: '#22c55e', border: '#16a34a', icon: 'üîß' },
      'testing': { bg: '#eab308', border: '#ca8a04', icon: 'üß™' },
      'unknown': { bg: '#6b7280', border: '#4b5563', icon: '‚ùì' },
    };

    const roleIcons = {
      'Orchestrator': 'üéº',
      'Worker': '‚öôÔ∏è',
      'Data': 'üì¶',
    };

        // ==========================================
        // DATA INJECTION ZONE
        // ==========================================
        // The generator will inject data between these markers.
        // DO NOT MODIFY THE MARKERS manually.

        /* <!-- DATA_INJECTION_START --> */
    const particles = [];
    const connections = [];
    const vizMetadata = {"generated_at": "2025-12-22T23:32:27.268253", "stats": {"total_nodes": 1, "total_edges": 0, "role_distribution": {"Controller": 1}, "coverage_percent": 100.0, "average_confidence": 75.0, "classification_time_seconds": 0.02}};
            /* <!-- DATA_INJECTION_END --> */

    // Safe layer color lookup with fallback
    function getLayerColor(layer) {
      return layerColors[layer] || layerColors['unknown'] || { bg: '#6b7280', border: '#4b5563', icon: '‚ùì' };
    }



    // ==========================================
    // VISUALIZATION ENGINE
    // ==========================================

    let network;
    let nodes;
    let edges;
    let activeFilters = { layers: new Set(), roles: new Set() };
    let currentLayout = 'force';
    let physicsEnabled = false;

    async function initGraph() {
      // Wait for library to load
      try {
        await window.visPromise;
      } catch (e) {
        logToScreen("Failed to wait for vis promise: " + e, "error");
      }

      if (typeof vis === 'undefined') {
        logToScreen("CRITICAL: Vis library object is undefined after load", "error");
        return;
      } else {
        logToScreen("Vis library loaded successfully. Version: " + (vis.version || "unknown"));
      }

      // Kind to shape mapping
      const kindShapes = {
        'class': 'box',
        'method': 'diamond',
        'function': 'ellipse'
      };

      try {
        // Debug: Log first particle
        logToScreen(`Processing ${particles.length} particles...`);
        if (particles.length > 0) {
          const sample = particles[0];
          logToScreen(`Sample node: ${sample.label}, Layer: ${sample.layer}`);
        }

        // Create nodes with rich visual mappings
        nodes = new vis.DataSet(particles.map(p => {
          const layerInfo = getLayerColor(p.layer);

          // Size based on complexity and LOC
          const baseSize = 18;
          const complexityBonus = Math.min((p.complexity || 0) * 2, 15);
          const locBonus = Math.log((p.lines_of_code || 1) + 1) * 3;
          const nodeSize = baseSize + complexityBonus + locBonus;

          // Border width based on connectivity
          const connections = (p.in_degree || 0) + (p.out_degree || 0);
          const borderWidth = Math.min(1 + connections / 3, 6);

          // Opacity based on role confidence
          const confidence = p.role_confidence || 70;
          const opacity = 0.5 + (confidence / 200);

          // Border dashes for LLM-classified nodes
          const borderDashes = p.discovery_method === 'llm' ? [5, 3] : false;

          return {
            id: p.id,
            label: p.label,
            title: `${p.name}\n${p.role} (${Math.round(confidence)}%)\n${p.kind} ‚Ä¢ ${p.lines_of_code} LOC`,
            group: p.layer,
            color: {
              background: layerInfo.bg,
              border: layerInfo.border,
              highlight: { background: '#fff', border: layerInfo.border },
              hover: { background: '#fff', border: layerInfo.border }
            },
            font: {
              color: '#000',
              size: 11,
              face: 'Inter',
              bold: { color: '#000' }
            },
            shape: kindShapes[p.kind] || 'ellipse',
            size: nodeSize,
            borderWidth: borderWidth,
            borderDashes: borderDashes,
            opacity: opacity,
            shadow: {
              enabled: p.is_hotspot,
              size: p.is_hotspot ? 15 : 10,
              color: p.is_hotspot ? 'rgba(239,68,68,0.5)' : 'rgba(0,0,0,0.3)'
            },
            ...p
          };
        }));

        // Create edges with rich visual mappings
        edges = new vis.DataSet(connections.map((c, i) => {
          // Edge styling based on type
          const edgeColor = c.color || '#00d4ff';
          const edgeDashes = c.dashes ? [5, 5] : false;
          const showArrows = c.arrows !== false;
          const edgeWidth = 1 + (c.weight || 1) * 0.5;
          const edgeOpacity = 0.3 + (c.confidence || 1) * 0.4;

          return {
            id: i,
            from: c.from,
            to: c.to,
            label: c.type !== 'CONTAINS' ? c.type : '',
            title: `${c.type}\nWeight: ${c.weight || 1}\nConfidence: ${Math.round((c.confidence || 1) * 100)}%`,
            arrows: { to: { enabled: showArrows, scaleFactor: 0.5 } },
            color: {
              color: edgeColor,
              opacity: edgeOpacity,
              highlight: '#00d4ff',
              hover: '#00d4ff'
            },
            dashes: edgeDashes,
            font: { color: '#666', size: 8, strokeWidth: 0, align: 'middle' },
            smooth: { type: 'curvedCW', roundness: 0.12 },
            width: edgeWidth,
            hoverWidth: edgeWidth + 1
          };
        }));

        // Options
        const options = getLayoutOptions(currentLayout);

        // Create network
        const container = document.getElementById('graph');
        network = new vis.Network(container, { nodes, edges }, options);

        // Event handlers
        network.on('click', handleNodeClick);
        network.on('stabilizationIterationsDone', () => network.fit({ animation: true }));

        updateStats();
        buildFilters();
      } catch (err) {
        logToScreen("CRITICAL ERROR in initGraph: " + err, "error");
        console.error(err);
      }
    }

    function getLayoutOptions(layout) {
      const base = {
        nodes: { borderWidthSelected: 3 },
        edges: { selectionWidth: 3 },
        interaction: {
          hover: true,
          tooltipDelay: 100,
          zoomView: true,
          dragView: true,
          multiselect: true
        },
      };

      switch (layout) {
        case 'hierarchical':
          return {
            ...base,
            layout: {
              hierarchical: {
                direction: 'UD',
                sortMethod: 'hubsize',
                levelSeparation: 100,
                nodeSpacing: 120,
                treeSpacing: 200
              }
            },
            physics: false
          };
        case 'radial':
          return {
            ...base,
            layout: { improvedLayout: true },
            physics: {
              solver: 'repulsion',
              repulsion: { nodeDistance: 200, centralGravity: 0.3 },
              stabilization: { iterations: 150 }
            }
          };
        case 'grid':
          return {
            ...base,
            layout: { improvedLayout: false },
            physics: false
          };
        default: // force
          return {
            ...base,
            layout: { improvedLayout: false },
            physics: {
              enabled: physicsEnabled,
              solver: 'forceAtlas2Based',
              forceAtlas2Based: {
                gravitationalConstant: -80,
                centralGravity: 0.01,
                springLength: 120,
                springConstant: 0.05,
                damping: 0.4
              },
              stabilization: false
            }
          };
      }
    }

    function setLayout(layout) {
      currentLayout = layout;
      document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');

      if (layout === 'grid') {
        // Manual grid layout
        const layerOrder = ['Interface', 'App', 'Core', 'Infra', 'Data', 'Tests'];
        const nodesByLayer = {};
        particles.forEach(p => {
          if (!nodesByLayer[p.layer]) nodesByLayer[p.layer] = [];
          nodesByLayer[p.layer].push(p);
        });

        let y = 0;
        layerOrder.forEach(layer => {
          const layerNodes = nodesByLayer[layer] || [];
          layerNodes.forEach((p, i) => {
            nodes.update({ id: p.id, x: i * 150, y: y });
          });
          y += 150;
        });
        network.setOptions({ physics: false });
        network.fit({ animation: true });
      } else {
        network.setOptions(getLayoutOptions(layout));
        if (layout !== 'grid') {
          network.stabilize();
        }
      }
    }

    function handleNodeClick(params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        const node = nodes.get(nodeId);
        showNodeDetails(node);
      }
    }

    function showNodeDetails(node) {
      const connectedEdges = network.getConnectedEdges(node.id);
      const outgoing = [];
      const incoming = [];

      connectedEdges.forEach(edgeId => {
        const edge = edges.get(edgeId);
        if (edge.from === node.id) {
          const target = nodes.get(edge.to);
          if (target) outgoing.push({ node: target, type: edge.label, edgeType: edge.label });
        } else {
          const source = nodes.get(edge.from);
          if (source) incoming.push({ node: source, type: edge.label, edgeType: edge.label });
        }
      });

      const layerInfo = getLayerColor(node.layer);
      const confidence = Math.round(node.role_confidence || 70);
      const filePath = node.file_path || '';
      const fileName = filePath.split('/').pop() || 'Unknown';
      const lineRange = node.start_line && node.end_line ? `L${node.start_line}-${node.end_line}` : '';

      // Format decorators
      const decorators = (node.decorators || []).map(d => `<span style="background:#a855f7;color:#fff;padding:2px 6px;border-radius:4px;margin-right:4px;font-size:0.7rem;">@${d}</span>`).join('');

      // Format params
      const params = (node.params || []).map(p => p.name || p).join(', ');

      // Format base classes
      const baseClasses = (node.base_classes || []).join(', ');

      // Code preview (limit to 300 chars)
      const codePreview = (node.body_source || '').slice(0, 300);
      const hasMoreCode = (node.body_source || '').length > 300;

      document.getElementById('node-details').innerHTML = `
                <div class="node-detail-header">
                    <div class="node-icon" style="background: ${layerInfo.bg}">
                        ${node.role_icon || layerInfo.icon}
                    </div>
                    <div style="flex:1">
                        <div class="node-title">${node.name || node.label}</div>
                        <div class="node-subtitle">${node.kind} ‚Ä¢ ${node.layer} Layer</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-size:0.8rem;color:${confidence >= 80 ? '#22c55e' : confidence >= 60 ? '#eab308' : '#ef4444'}">${confidence}%</div>
                        <div style="font-size:0.65rem;color:var(--text-secondary)">${node.discovery_icon || 'üîç'} ${node.discovery_method || 'pattern'}</div>
                    </div>
                </div>
                
                ${decorators ? `<div style="margin-bottom:12px">${decorators}</div>` : ''}
                
                <div class="section-title">Location</div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:16px;font-size:0.8rem">
                    <div style="color:var(--accent-cyan);cursor:pointer" title="${filePath}">${fileName} ${lineRange}</div>
                    ${node.signature ? `<div style="font-family:monospace;color:var(--text-secondary);margin-top:6px;font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${node.signature}</div>` : ''}
                </div>
                
                <div class="section-title">Metrics</div>
                <div class="dimension-grid">
                    <div class="dimension-card">
                        <div class="dimension-label">Role</div>
                        <div class="dimension-value">${node.role_icon || ''} ${node.role}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Kind</div>
                        <div class="dimension-value">${node.kind}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Complexity</div>
                        <div class="dimension-value">${node.complexity || 0}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">LOC</div>
                        <div class="dimension-value">${node.lines_of_code || 0}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">In / Out</div>
                        <div class="dimension-value">${node.in_degree || 0} / ${node.out_degree || 0}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Cost</div>
                        <div class="dimension-value">${node.estimated_cost || 0}</div>
                    </div>
                </div>
                
                ${params ? `
                <div class="section-title">Parameters</div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:16px;font-family:monospace;font-size:0.75rem;color:var(--text-secondary)">${params}</div>
                ` : ''}
                
                ${baseClasses ? `
                <div class="section-title">Inherits</div>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:16px;font-size:0.8rem;color:var(--accent-pink)">${baseClasses}</div>
                ` : ''}
                
                <div class="section-title">Dimensions</div>
                <div class="dimension-grid">
                    <div class="dimension-card">
                        <div class="dimension-label">Boundary</div>
                        <div class="dimension-value">${node.boundary}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">State</div>
                        <div class="dimension-value">${node.state}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Activation</div>
                        <div class="dimension-value">${node.activation}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Lifetime</div>
                        <div class="dimension-value">${node.lifetime}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Effect</div>
                        <div class="dimension-value">${node.effect}</div>
                    </div>
                    <div class="dimension-card">
                        <div class="dimension-label">Time Type</div>
                        <div class="dimension-value">${node.time_type}</div>
                    </div>
                </div>
                
                ${node.is_hotspot ? '<div style="background:#ef4444;color:#fff;padding:8px 12px;border-radius:8px;margin:12px 0;font-size:0.8rem;text-align:center">üî• Performance Hotspot</div>' : ''}
                ${node.is_entry_point ? '<div style="background:#22c55e;color:#fff;padding:8px 12px;border-radius:8px;margin:12px 0;font-size:0.8rem;text-align:center">üöÄ Entry Point</div>' : ''}
                
                ${codePreview ? `
                <div class="section-title">Code Preview</div>
                <pre style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:0.7rem;overflow-x:auto;white-space:pre-wrap;color:var(--text-secondary);max-height:150px">${codePreview}${hasMoreCode ? '...' : ''}</pre>
                ` : ''}
                
                ${outgoing.length > 0 ? `
                    <div class="section-title">Outgoing (${outgoing.length})</div>
                    <div class="connection-list">
                        ${outgoing.slice(0, 10).map(c => `
                            <div class="connection-item" onclick="focusNode('${c.node.id}')">
                                <span class="connection-arrow">‚Üí</span>
                                <span>${c.node.label}</span>
                                <span class="connection-type">${c.type || 'CALLS'}</span>
                            </div>
                        `).join('')}
                        ${outgoing.length > 10 ? `<div style="font-size:0.75rem;color:var(--text-secondary);padding:8px">...and ${outgoing.length - 10} more</div>` : ''}
                    </div>
                ` : ''}
                
                ${incoming.length > 0 ? `
                    <div class="section-title">Incoming (${incoming.length})</div>
                    <div class="connection-list">
                        ${incoming.slice(0, 10).map(c => `
                            <div class="connection-item" onclick="focusNode('${c.node.id}')">
                                <span class="connection-arrow">‚Üê</span>
                                <span>${c.node.label}</span>
                                <span class="connection-type">${c.type || 'CALLS'}</span>
                            </div>
                        `).join('')}
                        ${incoming.length > 10 ? `<div style="font-size:0.75rem;color:var(--text-secondary);padding:8px">...and ${incoming.length - 10} more</div>` : ''}
                    </div>
                ` : ''}
            `;
    }

    function focusNode(nodeId) {
      network.selectNodes([nodeId]);
      network.focus(nodeId, { scale: 1.5, animation: true });
      showNodeDetails(nodes.get(nodeId));
    }

    function updateStats() {
      document.getElementById('stat-nodes').textContent = particles.length;
      document.getElementById('stat-edges').textContent = connections.length;
      document.getElementById('stat-layers').textContent = Object.keys(layerColors).length;
      const maxEdges = particles.length * (particles.length - 1);
      const density = ((connections.length / maxEdges) * 100).toFixed(1);
      document.getElementById('stat-density').textContent = density + '%';
    }

    function buildFilters() {
      // Layer filters
      const layerCounts = {};
      particles.forEach(p => {
        layerCounts[p.layer] = (layerCounts[p.layer] || 0) + 1;
      });

      const layerFiltersHtml = Object.entries(layerColors).map(([layer, info]) => `
                <div class="filter-item active" data-layer="${layer}" onclick="toggleFilter('layer', '${layer}', this)">
                    <div class="filter-dot" style="background: ${info.bg}"></div>
                    <span class="filter-label">${layer}</span>
                    <span class="filter-count">${layerCounts[layer] || 0}</span>
                </div>
            `).join('');
      document.getElementById('layer-filters').innerHTML = layerFiltersHtml;

      // Role filters
      const roleCounts = {};
      particles.forEach(p => {
        roleCounts[p.role] = (roleCounts[p.role] || 0) + 1;
      });

      const roleFiltersHtml = Object.entries(roleIcons).map(([role, icon]) => `
                <div class="filter-item active" data-role="${role}" onclick="toggleFilter('role', '${role}', this)">
                    <span>${icon}</span>
                    <span class="filter-label">${role}</span>
                    <span class="filter-count">${roleCounts[role] || 0}</span>
                </div>
            `).join('');
      document.getElementById('role-filters').innerHTML = roleFiltersHtml;
    }

    function toggleFilter(type, value, element) {
      element.classList.toggle('active');
      const set = type === 'layer' ? activeFilters.layers : activeFilters.roles;
      if (set.has(value)) {
        set.delete(value);
      } else {
        set.add(value);
      }
      applyFilters();
    }

    function applyFilters() {
      const activeLayerFilters = document.querySelectorAll('[data-layer].active');
      const activeRoleFilters = document.querySelectorAll('[data-role].active');

      const activeLayers = new Set(Array.from(activeLayerFilters).map(el => el.dataset.layer));
      const activeRoles = new Set(Array.from(activeRoleFilters).map(el => el.dataset.role));

      nodes.forEach(node => {
        const visible = activeLayers.has(node.layer) && activeRoles.has(node.role);
        nodes.update({ id: node.id, hidden: !visible });
      });
    }

    function searchNodes(query) {
      const q = query.toLowerCase();
      nodes.forEach(node => {
        const match = !q || node.label.toLowerCase().includes(q);
        nodes.update({
          id: node.id,
          opacity: match ? 1 : 0.2,
          font: { ...node.font, color: match ? '#000' : '#999' }
        });
      });

      if (q) {
        const matches = particles.filter(p => p.label.toLowerCase().includes(q));
        if (matches.length === 1) {
          focusNode(matches[0].id);
        }
      }
    }

    function fitGraph() {
      network.fit({ animation: { duration: 500 } });
    }

    function togglePhysics() {
      physicsEnabled = !physicsEnabled;
      network.setOptions({ physics: { enabled: physicsEnabled } });
      event.target.classList.toggle('active');
    }

    function exportJSON() {
      const data = {
        particles: particles,
        connections: connections,
        exported_at: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spectrometer_graph.json';
      a.click();
    }

    // Initialize

    try {
      if (!particles || particles.length === 0) {
        console.warn("No particles data found. Waiting for injection or empty graph.");
      }
      initGraph();
    } catch (e) {
      console.error("Spectrometer Initialization Error:", e);
      document.body.innerHTML = `<div style="color:red; padding:20px; font-family:monospace">
                <h1>Spectrometer Error</h1>
                <p>Failed to initialize visualization.</p>
                <pre>${e.toString()}</pre>
            </div>`;
    }

  </script>
</body>

</html>