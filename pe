#!/usr/bin/env bash
# PROJECT ELEMENTS - Unified CLI
# Frictionless access to all tools
#
# TWO ABSTRACTIONS:
#   1. Explicit commands:  ./pe status, ./pe collider, ./pe ask
#   2. Intent routing:     ./pe "fix the auth bug" â†’ routes to right tool
#
# Intent routing is LOCAL (no API calls) - pattern matching only.
# Speed: <10ms for any command.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV="$SCRIPT_DIR/.tools_venv"
COLLIDER="$SCRIPT_DIR/standard-model-of-code"
TOOLS="$SCRIPT_DIR/context-management/tools"
AGENT="$SCRIPT_DIR/.agent"

# Auto-activate venv for Python tools
run_python() {
    if [ -f "$VENV/bin/python" ]; then
        "$VENV/bin/python" "$@"
    else
        python3 "$@"
    fi
}

# =============================================================================
# INTENT ROUTER (Second Abstraction) - LOCAL, ULTRAFAST
# =============================================================================
# Priority:
#   1. Pattern matching (<5ms)
#   2. Local LLM via Ollama if available (~100ms with small model)
#   3. Fallback to AI tool
#
# To enable local LLM: ollama pull llama3.2:1b

# Check if Ollama is available and fast model is pulled
has_ollama() {
    command -v ollama &>/dev/null && ollama list 2>/dev/null | grep -q "llama3.2:1b\|phi3:mini\|qwen2:0.5b"
}

# Route via local LLM (ultrafast, ~100ms)
route_via_ollama() {
    local input="$1"
    local prompt="Classify this user intent into ONE word from: [status, analyze, fix, explain, recent, stale, test, commit, drift, verify, sync, viz, ask]. Input: '$input'. Output only the category word, nothing else."

    local category=$(ollama run llama3.2:1b "$prompt" 2>/dev/null | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')

    case "$category" in
        status)  cmd_status; return 0 ;;
        analyze) cd "$COLLIDER" && ./collider full . --output .collider; return 0 ;;
        fix)     run_python "$TOOLS/ai/analyze.py" "$input" --set brain; return 0 ;;
        explain) run_python "$TOOLS/ai/analyze.py" "$input" --set brain; return 0 ;;
        recent)  python3 "$TOOLS/maintenance/tdj.py" recent 7; return 0 ;;
        stale)   python3 "$TOOLS/maintenance/tdj.py" stale 30; return 0 ;;
        test)    cmd_test; return 0 ;;
        commit)  git status --short; return 0 ;;
        drift)   cd "$COLLIDER" && ./collider symmetry . --docs docs; return 0 ;;
        verify)  cmd_verify; return 0 ;;
        sync)    cmd_sync; return 0 ;;
        viz)     cmd_viz; return 0 ;;
        ask)     run_python "$TOOLS/ai/analyze.py" "$input" --set brain; return 0 ;;
        *)       return 1 ;;
    esac
}

route_intent() {
    local input="$*"
    local lower=$(echo "$input" | tr '[:upper:]' '[:lower:]')

    # HEALTH / STATUS patterns
    if [[ "$lower" =~ (health|status|how.*(system|doing|going)|check.*system|overview|state) ]]; then
        cmd_status
        return 0
    fi

    # ANALYZE / SCAN patterns
    if [[ "$lower" =~ (analyze|scan|parse|inspect).*(code|repo|codebase) ]]; then
        cd "$COLLIDER" && ./collider full . --output .collider
        return 0
    fi

    # FIX / DEBUG patterns â†’ route to AI with context
    if [[ "$lower" =~ ^(fix|debug|solve|repair|broken) ]]; then
        run_python "$TOOLS/ai/analyze.py" "$input" --set brain
        return 0
    fi

    # EXPLAIN / HOW / WHAT / WHY patterns â†’ AI question
    if [[ "$lower" =~ ^(explain|how|what|why|where|when|who|describe|tell) ]]; then
        run_python "$TOOLS/ai/analyze.py" "$input" --set brain
        return 0
    fi

    # RECENT / NEW / CREATED patterns â†’ TDJ
    if [[ "$lower" =~ (recent|new|created|added).*(file|today|week|yesterday) ]]; then
        python3 "$TOOLS/maintenance/tdj.py" recent 7
        return 0
    fi

    # STALE / OLD / UNUSED patterns â†’ TDJ stale
    if [[ "$lower" =~ (stale|old|unused|untouched|dead) ]]; then
        python3 "$TOOLS/maintenance/tdj.py" stale 30
        return 0
    fi

    # TEST patterns
    if [[ "$lower" =~ ^(test|run.*test|check.*test) ]]; then
        cmd_test
        return 0
    fi

    # COMMIT / SAVE patterns
    if [[ "$lower" =~ ^(commit|save|checkpoint) ]]; then
        git status --short
        echo ""
        echo "Ready to commit. Use: git add -A && git commit -m 'message'"
        return 0
    fi

    # DRIFT / SYMMETRY / ALIGNMENT patterns
    if [[ "$lower" =~ (drift|symmetry|alignment|wave.*particle|doc.*code) ]]; then
        cd "$COLLIDER" && ./collider symmetry . --docs docs
        return 0
    fi

    # VERIFY / AUDIT / VALIDATE patterns â†’ HSL
    if [[ "$lower" =~ (verify|audit|validate|check.*doc|socratic|hsl) ]]; then
        cmd_verify
        return 0
    fi

    # SYNC / MIRROR / BACKUP / CLOUD patterns â†’ archive mirror
    if [[ "$lower" =~ (sync|mirror|backup|cloud|push.*gcs|upload) ]]; then
        cmd_sync
        return 0
    fi

    # VISUALIZE / GRAPH / SEE / SHOW patterns â†’ viz server
    if [[ "$lower" =~ (visuali|graph|see.*code|show.*(graph|viz|3d)|open.*report) ]]; then
        cmd_viz
        return 0
    fi

    # Pattern matching failed - try local LLM if available
    if has_ollama; then
        route_via_ollama "$input" && return 0
    fi

    # No match - return 1
    return 1
}

# Commands
cmd_help() {
    cat << 'EOF'
PROJECT ELEMENTS - Unified CLI

EXPLICIT COMMANDS:
  ./pe status              System health overview
  ./pe wire                Full pipeline (LOLâ†’TDJâ†’Colliderâ†’SMoCâ†’Unify)
  ./pe wire --quick        Skip Collider (use cached)
  ./pe wire --dashboard    Show health dashboard only
  ./pe ask "question"      Ask AI (Gemini) a question
  ./pe research "topic"    Deep research with validation
  ./pe deck [cmd]          Decision Deck (list|deal|route|show|play)
  ./pe collider <args>     Run Collider analysis
  ./pe viz                 Start 3D visualization server
  ./pe verify              Run HSL Socratic audit
  ./pe sync                Mirror to cloud (GCS)
  ./pe autopilot <cmd>     Automation control
  ./pe tdj <cmd>           Temporal index queries
  ./pe boot                Run boot sequence
  ./pe test                Run all tests

INTENT ROUTING (just type naturally):
  ./pe "how is the system doing"     â†’ status
  ./pe "analyze the codebase"        â†’ collider full
  ./pe "fix the auth bug"            â†’ AI analysis
  ./pe "what files were added today" â†’ tdj recent
  ./pe "check for stale code"        â†’ tdj stale
  ./pe "run tests"                   â†’ pytest
  ./pe "check drift"                 â†’ symmetry check
  ./pe "verify the docs"             â†’ HSL audit
  ./pe "sync to cloud"               â†’ archive mirror
  ./pe "show the graph"              â†’ 3D visualization

LOCATIONS:
  Collider:    standard-model-of-code/
  AI Tools:    context-management/tools/ai/
  Automation:  .agent/tools/
EOF
}

cmd_status() {
    echo "=== PROJECT ELEMENTS STATUS ==="
    echo ""

    # Git status
    echo "Git: $(git branch --show-current) | $(git status --short | wc -l | tr -d ' ') changes"

    # Autopilot
    if [ -f "$AGENT/tools/autopilot.py" ]; then
        python3 "$AGENT/tools/autopilot.py" status 2>/dev/null | grep -E "^(Autopilot|Level|Systems:)" | head -5
    fi

    # TDJ summary
    if [ -f "$TOOLS/maintenance/tdj.py" ]; then
        echo ""
        python3 "$TOOLS/maintenance/tdj.py" summary 2>/dev/null | head -6
    fi
}

cmd_ask() {
    if [ -z "$1" ]; then
        echo "Usage: ./pe ask \"your question\""
        exit 1
    fi
    run_python "$TOOLS/ai/analyze.py" "$@" --set brain
}

cmd_research() {
    if [ -z "$1" ]; then
        echo "Usage: ./pe research \"topic\""
        exit 1
    fi
    run_python "$TOOLS/ai/analyze.py" "$@" --research validation_trio
}

cmd_deck() {
    # Decision Deck - certified moves for AI agents
    case "${1:-list}" in
        play)
            shift
            run_python "$TOOLS/ai/deck/play_card.py" "$@"
            ;;
        context)
            shift
            run_python "$TOOLS/ai/deck/deck_context.py" "$@"
            ;;
        health)
            run_python "$TOOLS/ai/deck/deck_context.py" --health
            ;;
        *)
            run_python "$TOOLS/ai/deck/deck_router.py" "$@"
            ;;
    esac
}

cmd_collider() {
    cd "$COLLIDER" && ./collider "$@"
}

cmd_autopilot() {
    python3 "$AGENT/tools/autopilot.py" "$@"
}

cmd_tdj() {
    python3 "$TOOLS/maintenance/tdj.py" "$@"
}

cmd_boot() {
    bash "$TOOLS/maintenance/boot.sh"
}

cmd_test() {
    cd "$COLLIDER" && pytest tests/ -q
}

cmd_verify() {
    echo "=== HSL SOCRATIC AUDIT ==="
    run_python "$TOOLS/ai/analyze.py" --verify pipeline
}

cmd_sync() {
    echo "=== CLOUD MIRROR ==="
    run_python "$TOOLS/archive/archive.py" mirror
}

cmd_viz() {
    echo "=== STARTING VISUALIZATION ==="
    cd "$COLLIDER" && python3 -m http.server 8080 --directory .collider 2>/dev/null &
    echo "Server starting at http://localhost:8080/collider_report.html"
    echo "Press Ctrl+C to stop"
    sleep 1
    open "http://localhost:8080/collider_report.html" 2>/dev/null || echo "Open browser to the URL above"
    wait
}

cmd_wire() {
    echo "=== WIRE - Grand Orchestrator ==="
    python3 "$AGENT/tools/wire.py" "$@"
}

# Router
case "${1:-help}" in
    help|--help|-h)
        cmd_help
        ;;
    status)
        cmd_status
        ;;
    ask)
        shift
        cmd_ask "$@"
        ;;
    research)
        shift
        cmd_research "$@"
        ;;
    deck|cards|moves)
        shift
        cmd_deck "$@"
        ;;
    collider)
        shift
        cmd_collider "$@"
        ;;
    autopilot)
        shift
        cmd_autopilot "$@"
        ;;
    tdj)
        shift
        cmd_tdj "$@"
        ;;
    boot)
        cmd_boot
        ;;
    test)
        cmd_test
        ;;
    intel)
        shift
        run_python "$TOOLS/ai/intel.py" "$@"
        ;;
    verify|audit)
        cmd_verify
        ;;
    sync|mirror)
        cmd_sync
        ;;
    viz|graph|see)
        cmd_viz
        ;;
    wire)
        shift
        cmd_wire "$@"
        ;;
    *)
        # Not a known command - try intent routing
        if route_intent "$@"; then
            exit 0
        fi

        # Check if there's a matching card before AI fallback
        MATCHED_CARD=$(run_python "$TOOLS/ai/deck/deck_router.py" route "$*" 2>/dev/null | head -1)
        if [[ "$MATCHED_CARD" == Matched:* ]]; then
            echo "ðŸ’¡ TIP: Found certified move - $MATCHED_CARD"
            echo "   Run: ./pe deck route \"$*\""
            echo ""
        fi

        # Intent routing failed - fallback to AI as last resort
        echo "â†’ Routing to AI: $*"
        run_python "$TOOLS/ai/analyze.py" "$*" --set brain
        ;;
esac
