<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚õèÔ∏è Process Mining Engine - Dynamic Log Analysis</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-hover: #21262d;
            --border: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr;
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .brand-icon {
            font-size: 24px;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-left: 10px;
            border-left: 1px solid var(--border);
            padding-left: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        button:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        button.primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Sidebar */
        aside {
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        #log-container {
            flex: 1;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }

        .log-entry {
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
            color: var(--text-secondary);
        }

        .log-entry:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .log-time {
            color: var(--accent-purple);
            width: 60px;
        }

        .log-case {
            color: var(--accent-blue);
            width: 80px;
        }

        .log-act {
            flex: 1;
        }

        .stats-panel {
            padding: 15px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        /* Main Canvas */
        main {
            position: relative;
            background: #0d1117;
            background-image: radial-gradient(#30363d 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        #mynetwork {
            width: 100%;
            height: 100%;
        }

        .overlay-note {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            max-width: 300px;
            font-size: 0.8rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            width: 600px;
            border: 1px solid var(--border);
        }

        textarea {
            width: 100%;
            height: 200px;
            background: #0d1117;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px;
            font-family: monospace;
            margin: 15px 0;
            border-radius: 6px;
        }

        .overlay-note h4 {
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .link {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        /* Animation Controls */
        #playback-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-card);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 100;
        }

        #time-slider {
            width: 300px;
            accent-color: var(--accent-blue);
        }

        #time-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            width: 200px;
        }

        .active-view {
            background: var(--accent-blue) !important;
            color: black !important;
        }
    </style>
</head>

<body>
    <header>
        <div class="brand">
            <span class="brand-icon">üí∏</span>
            <span>Money Flow Engine</span>
            <span class="tagline">CSV -> Visual Orbs</span>
        </div>
        <div class="controls">
            <button onclick="showCSVModal()">üìÇ Load CSV</button>
            <button onclick="generateData()">üé≤ Demo Data</button>
            <button onclick="togglePhysics()" id="btn-physics">‚öõÔ∏è Physics: OFF</button>
            <div style="width: 1px; height: 20px; background: #333; margin: 0 10px;"></div>
            <button onclick="switchView('graph')" id="btn-view-graph" class="active-view">üï∏Ô∏è Graph</button>
            <button onclick="switchView('sankey')" id="btn-view-sankey">üåä Flow</button>
            <button onclick="switchView('sunburst')" id="btn-view-sunburst">üç© Breakdown</button>
        </div>
    </header>

    <div id="csv-modal" class="modal">
        <div class="modal-content">
            <h3>Paste your Bank/CC CSV</h3>
            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 10px">
                Format: Date, Description, Amount (or just copy-paste from Excel)
            </p>
            <textarea id="csv-input"
                placeholder="2023-12-01, Uber, -25.50&#10;2023-12-01, Spotify, -15.00..."></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeCSVModal()">Cancel</button>
                <button class="primary" onclick="processCSV()">Visualize Flow üöÄ</button>
            </div>
        </div>
    </div>

    <aside>
        <div class="panel-header">
            <span>Event Log Stream</span>
            <span id="event-count" style="color: var(--accent-green)">0</span>
        </div>
        <div id="log-container"></div>
        <div class="stats-panel">
            <div class="stat-row">
                <span>Total Cases:</span>
                <strong id="stat-cases">0</strong>
            </div>
            <div class="stat-row">
                <span>Unique Activities:</span>
                <strong id="stat-nodes">0</strong>
            </div>
            <div class="stat-row">
                <span>Process Variants:</span>
                <strong id="stat-variants">0</strong>
            </div>
    </aside>

    <main>
        <div id="mynetwork"></div>
        <div id="echarts-view"
            style="display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--bg-dark);">
        </div>
        <canvas id="particle-canvas"></canvas>

        <div id="playback-controls">
            <button id="play-btn" onclick="toggleAnimation()">‚ñ∂ Play</button>
            <input type="range" id="time-slider" min="0" max="100" value="0" step="0.1"
                oninput="seekAnimation(this.value)">
            <span id="time-display">00:00:00</span>
        </div>

        <div class="overlay-note">
            <h4>üí° Logic Ported from yFiles</h4>
            <p>
                This engine implements the <code>extractGraph(eventLog)</code> algorithm found in the yFiles Process
                Mining component.
            </p>
            <p style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary)">
                1. Groups events by Case ID<br>
                2. Sorts by Timestamp<br>
                3. Infers nodes & transitions<br>
                4. Calculates frequency (Heat)
            </p>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border)">
                <a class="link"
                    href="https://github.com/yWorks/yfiles-for-html-demos/tree/master/demos/showcase/processmining"
                    target="_blank">View Logic Source (GitHub)</a>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 1. DATA GENERATOR
        // ==========================================

        const ACTIVITIES = [
            'Order Received', 'Check Credit', 'Check Stock',
            'Validate Info', 'Approve', 'Reject',
            'Ship Goods', 'Issue Invoice', 'Receive Payment', 'Close Order'
        ];

        // Simulate some process variants
        const VARIANTS = [
            // Happy Path
            [0, 1, 3, 2, 4, 6, 7, 8, 9],
            // Quick Rejection
            [0, 1, 5, 9],
            // Stock Issue
            [0, 2, 3, 5, 9],
            // Fast Track
            [0, 4, 6, 9]
        ];

        let eventLog = [];

        function generateData() {
            eventLog = [];
            const caseCount = 500;
            const startDate = new Date();

            for (let i = 0; i < caseCount; i++) {
                const caseId = `C-${1000 + i}`;
                const variant = VARIANTS[Math.floor(Math.random() * VARIANTS.length)];

                let currentTime = new Date(startDate.getTime() + Math.random() * 10000000);

                variant.forEach(actIdx => {
                    // Add some random noise/loops occasionally
                    if (Math.random() > 0.9) {
                        // Loop back or skip
                    }

                    eventLog.push({
                        caseId: caseId,
                        activity: ACTIVITIES[actIdx],
                        timestamp: currentTime.getTime(), // Sortable timestamp
                        displayTime: currentTime.toLocaleTimeString()
                    });

                    // Advance time by 5-120 mins
                    currentTime = new Date(currentTime.getTime() + (5 + Math.random() * 115) * 60000);
                });
            }

            // Randomize log order to simulate real ingestion
            eventLog.sort(() => Math.random() - 0.5);

            renderLog();
            mineGraph();
        }

        // ==========================================
        // 2. MINING ENGINE (The "Processing" Part)
        // ==========================================

        // PROGRESSIVE RENDERER (Fixes massive loading time)
        function renderLog() {
            const container = document.getElementById('log-container');
            container.innerHTML = '';
            document.getElementById('event-count').innerText = eventLog.length;

            const totalEvents = eventLog.length;
            const CHUNK_SIZE = 100; // Render 100 at a time
            let currentIdx = 0;

            function renderChunk() {
                const chunkEnd = Math.min(currentIdx + CHUNK_SIZE, totalEvents);
                const fragment = document.createDocumentFragment();

                for (let i = currentIdx; i < chunkEnd; i++) {
                    const e = eventLog[i];
                    const row = document.createElement('div');
                    row.className = 'log-entry';

                    // Generate color for Case ID
                    const caseColor = e.color || stringToColor(e.caseId);

                    // Format Time: Show Date if strictly necessary, or just Time for compactness
                    // For the log, we'll keep it compact but maybe add a tooltip
                    const timeStr = e.displayTime || new Date(e.timestamp).toLocaleTimeString().split(' ')[0];
                    const dateStr = new Date(e.timestamp).toLocaleDateString();

                    row.innerHTML = `
                        <div class="log-time" title="${dateStr}">${timeStr}</div>
                        <div class="log-case" style="color:${caseColor}">${e.caseId}</div>
                        <div class="log-act" title="${e.activity}">${e.activity}</div>
                    `;
                    fragment.appendChild(row);
                }

                container.appendChild(fragment);
                currentIdx += CHUNK_SIZE;

                if (currentIdx < totalEvents) {
                    requestAnimationFrame(renderChunk);
                }
            }

            renderChunk();
        }

        function mineGraph() {
            // A. Group by Case
            const cases = {};
            eventLog.forEach(e => {
                if (!cases[e.caseId]) cases[e.caseId] = [];
                cases[e.caseId].push(e);
            });

            // B. Sort attributes & Extract Flows
            const nodesMap = {}; // activity -> count
            const edgesMap = {}; // "from->to" -> count

            const uniqueVariants = new Set();

            Object.keys(cases).forEach(caseId => {
                // Sort by time (crucial for process mining)
                const trace = cases[caseId].sort((a, b) => a.timestamp - b.timestamp);

                // Track variants
                const pathStr = trace.map(e => e.activity).join('‚Üí');
                uniqueVariants.add(pathStr);

                // Build Graph Elements
                for (let i = 0; i < trace.length; i++) {
                    const curr = trace[i].activity;

                    // Node Frequency
                    nodesMap[curr] = (nodesMap[curr] || 0) + 1;

                    // Edge Frequency
                    if (i > 0) {
                        const prev = trace[i - 1].activity;
                        const edgeKey = `${prev}|${curr}`;
                        edgesMap[edgeKey] = (edgesMap[edgeKey] || 0) + 1;
                    }
                }
            });

            // C. Convert to Vis.js Format
            const maxNodeFreq = Math.max(...Object.values(nodesMap));
            const maxEdgeFreq = Math.max(...Object.values(edgesMap));

            const visNodes = Object.keys(nodesMap).map((act, idx) => {
                const freq = nodesMap[act];
                const intensity = freq / maxNodeFreq;

                // yFiles-Inspired Color Palette (Teal/Slate)
                const TEAL_PRIMARY = '#5C91A6';
                const TEAL_LIGHT = '#62B5CC';
                const SLATE = '#444';
                const GRAY = '#888';

                // Color by frequency: High-freq (Banks) = Teal, Low-freq = Gray
                const color = intensity > 0.5 ? TEAL_PRIMARY : (intensity > 0.3 ? TEAL_LIGHT : SLATE);

                // Hub Detection: Scale node size by frequency (connections)
                const baseSize = 30;
                const hubSize = baseSize + (freq * 3); // Banks get bigger

                return {
                    id: act,
                    label: `${act}\n(${freq})`,
                    size: hubSize, // yFiles-style hub sizing
                    mass: 1 + (freq / 3), // Heavier nodes (Banks) stay central
                    color: {
                        background: color,
                        border: '#fff',
                        highlight: { background: TEAL_LIGHT, border: '#fff' }
                    },
                    font: { color: '#fff', size: 12, face: 'Inter' }
                };
            });

            const visEdges = Object.keys(edgesMap).map(key => {
                const [from, to] = key.split('|');
                const freq = edgesMap[key];
                return {
                    from: from,
                    to: to,
                    value: freq, // Thickness by frequency
                    label: freq.toString(),
                    font: { align: 'middle', size: 10, color: '#666' },
                    arrows: 'to',
                    color: { color: '#62B5CC', highlight: '#5C91A6', opacity: 0.6 }
                };
            });

            // D. Stat Updates
            document.getElementById('stat-cases').innerText = Object.keys(cases).length;
            document.getElementById('stat-nodes').innerText = Object.keys(nodesMap).length;
            document.getElementById('stat-variants').innerText = uniqueVariants.size;

            prepareAnimation(cases); // Prepare animation data
            renderGraph(visNodes, visEdges);
        }

        // ==========================================
        // 3. VISUALIZATION
        // ==========================================

        let network;

        function renderGraph(nodes, edges) {
            const container = document.getElementById('mynetwork');
            const data = {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };
            const options = {
                nodes: {
                    shape: 'box',
                    margin: 10,
                    shadow: true
                },
                edges: {
                    smooth: { type: 'cubicBezier', forceDirection: 'horizontal' }
                },
                layout: {
                    hierarchical: {
                        direction: 'LR',
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 100
                    }
                },
                physics: false
            };

            if (network) network.destroy();

            network = new vis.Network(container, data, options);

            // Bind Animation Drawing Layer
            network.on("afterDrawing", drawParticles);

            // Fix layout bug
            setTimeout(() => network.fit(), 500);
        }

        function fitGraph() {
            if (network) network.fit({ animation: true });
        }

        let isPhysicsOn = false;
        function togglePhysics() {
            isPhysicsOn = !isPhysicsOn;
            const btn = document.getElementById('btn-physics');
            btn.innerText = isPhysicsOn ? "‚öõÔ∏è Physics: ON" : "‚öõÔ∏è Physics: OFF";
            btn.style.background = isPhysicsOn ? "var(--accent-purple)" : "var(--bg-card)";
            btn.style.color = isPhysicsOn ? "white" : "var(--text-primary)";

            // Toggle between Hierarchical (Structured) and Physics (Organic)
            network.setOptions({
                layout: {
                    hierarchical: {
                        enabled: !isPhysicsOn,
                        direction: 'LR',
                        sortMethod: 'directed',
                        levelSeparation: 250, // More space
                        nodeSpacing: 150
                    },
                    improvedLayout: !isPhysicsOn // Disable for Physics to speed up
                },
                physics: {
                    enabled: isPhysicsOn,
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        theta: 0.5,
                        gravitationalConstant: -50,  // Less repulsion = less spinning
                        centralGravity: 0.05,        // Stronger center pull
                        springLength: 120,           // Tighter layout
                        springConstant: 0.08,        // Stronger springs = less wobble
                        damping: 0.9,                // HIGH damping = kills momentum fast
                        avoidOverlap: 1
                    },
                    stabilization: {
                        enabled: true,
                        iterations: 200,             // Fewer iterations = faster settle
                        updateInterval: 25,
                        fit: true                    // Auto-fit after stabilizing
                    }
                }
            });
        }

        // ==========================================
        // 3.5. FANCY VIEWS (ECharts)
        // ==========================================
        let echartsInstance = null;

        function switchView(mode) {
            // Update Buttons
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active-view'));
            document.getElementById(`btn-view-${mode}`).classList.add('active-view');

            const graphDiv = document.getElementById('mynetwork');
            const canvasDiv = document.getElementById('particle-canvas');
            const echartsDiv = document.getElementById('echarts-view');
            const controlsDiv = document.querySelector('.controls'); // Check if we need to hide specific controls

            if (mode === 'graph') {
                graphDiv.style.display = 'block';
                canvasDiv.style.display = 'block';
                echartsDiv.style.display = 'none';
            } else {
                graphDiv.style.display = 'none';
                canvasDiv.style.display = 'none';
                echartsDiv.style.display = 'block';

                // Initialize ECharts if needed
                if (!echartsInstance) echartsInstance = echarts.init(echartsDiv, 'dark');
                echartsInstance.resize();
                // Clear previous chart to prevent merging
                echartsInstance.clear();

                if (mode === 'sankey') renderSankey();
                if (mode === 'sunburst') renderSunburst();
            }
        }

        function renderSankey() {
            if (!window.sankeyData || window.sankeyData.nodes.length === 0) {
                echartsInstance.setOption({
                    title: { text: 'No Data Available (Check Input)', left: 'center', top: 'center', textStyle: { color: '#666' } },
                    series: []
                });
                return;
            }

            echartsInstance.setOption({
                backgroundColor: '#1a1a1a',
                title: { text: 'Money Flow (Filtered)', left: 'center', top: 20 },
                tooltip: { trigger: 'item', triggerOn: 'mousemove' },
                series: [{
                    type: 'sankey',
                    data: window.sankeyData.nodes,
                    links: window.sankeyData.links,
                    emphasis: { focus: 'adjacency' },
                    lineStyle: { color: 'gradient', curveness: 0.5 },
                    label: { color: '#fff' }
                }]
            });
        }

        function renderSunburst() {
            if (!window.sunburstData) return;

            echartsInstance.setOption({
                backgroundColor: '#1a1a1a',
                title: { text: 'Spending Breakdown by Bank', left: 'center', top: 20 },
                series: [{
                    type: 'sunburst',
                    data: window.sunburstData,
                    radius: ['10%', '90%'],
                    label: { rotate: 'radial', color: '#fff' },
                    itemStyle: {
                        borderRadius: 7,
                        borderWidth: 2
                    }
                }]
            });
        }

        // ==========================================
        // 4. ANIMATION ENGINE (The "Show It" Part)
        // ==========================================

        let animationData = [];
        let minTime = 0;
        let maxTime = 0;
        let playbackTime = 0;
        let isPlaying = false;
        let animationFrame;
        const PLAYBACK_SPEED = 1000 * 60 * 60; // 1 hr per frame (approx)

        function prepareAnimation(cases) {
            animationData = [];
            let globalMin = Infinity;
            let globalMax = -Infinity;

            Object.keys(cases).forEach(caseId => {
                const trace = cases[caseId];
                // For each step i -> i+1
                for (let i = 0; i < trace.length - 1; i++) {
                    const startEvt = trace[i];
                    const endEvt = trace[i + 1];

                    if (startEvt.timestamp < globalMin) globalMin = startEvt.timestamp;
                    if (endEvt.timestamp > globalMax) globalMax = endEvt.timestamp;

                    animationData.push({
                        caseId: caseId,
                        fromId: startEvt.activity,
                        toId: endEvt.activity,
                        startTime: startEvt.timestamp,
                        endTime: endEvt.timestamp,
                        color: stringToColor(caseId)
                    });
                }
            });

            minTime = globalMin;
            maxTime = globalMax;
            playbackTime = minTime;

            // Update Slider
            const slider = document.getElementById('time-slider');
            slider.value = 0;
            updateTimeDisplay();
        }

        function toggleAnimation() {
            isPlaying = !isPlaying;
            document.getElementById('play-btn').innerText = isPlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
            if (isPlaying) animate();
        }

        function seekAnimation(percent) {
            playbackTime = minTime + (percent / 100) * (maxTime - minTime);
            updateTimeDisplay();
            network.redraw(); // Trigger drawParticles
        }

        function updateTimeDisplay() {
            const date = new Date(playbackTime);
            document.getElementById('time-display').innerText = date.toLocaleString();
        }

        function animate() {
            if (!isPlaying) return;

            // Advance time (Slower playback for full year: 2000 frames ~= 33 seconds)
            playbackTime += (maxTime - minTime) / 2000;
            if (playbackTime > maxTime) playbackTime = minTime;

            // Sync Slider
            const percent = ((playbackTime - minTime) / (maxTime - minTime)) * 100;
            document.getElementById('time-slider').value = percent;
            updateTimeDisplay();
            network.redraw(); // Triggers afterDrawing
            animationFrame = requestAnimationFrame(animate);
        }

        function drawParticles(ctx) {
            if (animationData.length === 0) return;

            const activeParticles = animationData.filter(p =>
                playbackTime >= p.startTime && playbackTime <= p.endTime
            );

            // Batch get positions
            const nodesToQuery = new Set();
            activeParticles.forEach(p => { nodesToQuery.add(p.fromId); nodesToQuery.add(p.toId); });
            const positions = network.getPositions(Array.from(nodesToQuery));

            // Setup Heatmap Style
            ctx.globalCompositeOperation = 'lighter'; // Additive

            activeParticles.forEach(p => {
                const posFrom = positions[p.fromId];
                const posTo = positions[p.toId];

                if (!posFrom || !posTo) return;

                const duration = p.endTime - p.startTime;
                const elapsed = playbackTime - p.startTime;
                const progress = elapsed / duration;

                const x = posFrom.x + (posTo.x - posFrom.x) * progress;
                const y = posFrom.y + (posTo.y - posFrom.y) * progress;

                // Fire Flow Style
                // Small, hot, numerous
                const size = 3;
                const glow = 12;

                const gradient = ctx.createRadialGradient(x, y, 0, x, y, glow);

                // Uniform Hot Colors (Orange/Red)
                // We ignore p.color (case color) to enforce "Heat" look
                gradient.addColorStop(0, 'rgba(255, 200, 100, 1)');   // White/Yellow Hot
                gradient.addColorStop(0.2, 'rgba(255, 100, 0, 0.5)'); // Orange Core
                gradient.addColorStop(1, 'rgba(100, 0, 0, 0)');       // Red Fade

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, glow, 0, 2 * Math.PI);
                ctx.fill();
            });

            ctx.globalCompositeOperation = 'source-over';
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // ==========================================
        // 5. CSV CSV PARSER (The "Money Flow" Part)
        // ==========================================

        // INJECTED DATA FROM USER FILE (First ~500 lines)
        const USER_DATA = `transactionId,date,description,amount,currencyCode,type,status,category,categoryId,accountId,accountName,accountType,connectionId,connectorId,connectorName
txn_aeb8a490-adf0-4827-8246-c826f0978ff4,2025-12-10T02:59:00.000Z,REND PAGO APLIC AUT MAIS,0.01,BRL,CREDIT,POSTED,Proceeds interests and dividends,03060000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_d5d5651a-ca51-4355-8ef0-22a1cfaca0a4,2025-12-09T23:52:59.005Z,PIX QRS Latam Gatew09/12,-79,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_be14fb72-a715-41b3-b415-5b5f8fd39438,2025-12-09T16:02:15.074Z,PIX QRS Gowd Instit09/12,-666,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_e3eb93c6-5c77-4c95-bd8a-ed276490ca8e,2025-12-09T05:41:37.026Z,PIX QRS GOWD INSTIT09/12,-1666,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_f1cdacd6-0365-4290-8a78-19267ef6cd00,2025-12-08T23:00:41.017Z,PIX TRANSF GOWD IN08/12,329.5,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_be30bbe8-0276-4dbd-9983-0ae24aa075cf,2025-12-08T07:18:55.096Z,SISPAG ASSOCIACAO BRASILEIR,2028,BRL,CREDIT,POSTED,Income,01000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_61a8656e-3d09-48f8-9213-ebdd6a8b779f,2025-12-07T10:30:39.940Z,Enviado - Pix com QR Code,-374,BRL,DEBIT,POSTED,Transfer - PIX,05070000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_20e3054e-1832-4128-9b3c-770218c19154,2025-12-07T10:29:44.590Z,Recebido - Pix,374,BRL,CREDIT,POSTED,Non-recurring income,01050000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_9ba4efd7-32e7-4989-ae1a-7dda0a906973,2025-12-07T10:26:27.560Z,Enviado - Pix,-34,BRL,DEBIT,POSTED,Transfer - PIX,05070000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_90fa0fec-efe8-492c-aa2c-b8cfa04f6b5e,2025-12-07T10:25:17.540Z,Resgate do limite,34,BRL,CREDIT,POSTED,Investments,03000000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_ba1dc24f-0348-400d-a919-38c1e3852dd1,2025-12-07T10:21:21.760Z,Enviado - Pix,-150,BRL,DEBIT,POSTED,Transfer - PIX,05070000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_5346a51e-f44f-4095-ab63-404f98c8f005,2025-12-05T13:51:51.920Z,Cart√£o RecargaPay,0.5,BRL,CREDIT,POSTED,Transfers,05000000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_2e5481a8-a230-4129-9083-7236f86a3640,2025-12-05T13:51:14.440Z,Pagamento de fatura,-33.6,BRL,DEBIT,POSTED,Transfers,05000000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_1273b01a-2089-4964-84d4-ea8f6a88e1aa,2025-12-05T13:51:10.200Z,Recebido - Pix com chave,33.6,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_401c38c8-57c1-408f-8d40-8ff4fed61487,2025-12-05T13:44:33.073Z,PIX TRANSF LEONARD05/12,-1549,BRL,DEBIT,POSTED,Same person transfer,04000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_cfbc0bb3-cd69-4d08-89dc-2b1a9c7f4bd5,2025-12-05T13:40:11.055Z,PIX QRS Zippi Fundo05/12,-798.75,BRL,DEBIT,POSTED,Mutual funds,03030000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_a7f97b89-f75c-470b-ab4e-3b0a2d922173,2025-12-05T13:24:05.048Z,PIX TRANSF Henriqu05/12,-350,BRL,DEBIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_62cc5b1e-3cd7-4cc2-9c15-2fb0ff8eeead,2025-12-05T11:02:54.083Z,PIX TRANSF OSVANDR05/12,750,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_2a5f41b5-acf8-4b86-98a6-b6e36572126f,2025-12-05T11:00:08.036Z,PIX TRANSF OSVANDR05/12,2000,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_75ee8753-11b4-44a7-9d51-3fd1607a007f,2025-12-04T03:00:00.000Z,PIX GOWD INSTITUIC02/03,644.4,BRL,DEBIT,PENDING,Shopping,08000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_cbdb1419-6de8-409d-94ff-9a68ee65d519,2025-12-04T03:00:00.000Z,PIX LATAM GATEWAY 02/03,1074,BRL,DEBIT,PENDING,Shopping,08000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_7ac3ecf8-ed08-4c27-9be8-04869160c5c3,2025-12-04T03:00:00.000Z,MERCADOLIVRE*MERCA02/12,687.3,BRL,DEBIT,PENDING,Online shopping,08010000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_6db85ce2-8d4f-4e2e-a3b0-28eefbdfab3f,2025-12-04T03:00:00.000Z,FARMACIA SAO JOAO 03/03,57.72,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_33029672-d2b5-4961-8143-9a26e5e9e3ce,2025-12-04T03:00:00.000Z,PANVEL MATRIZ     03/05,115.19,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_1619c6fa-fb0f-45ed-9ebf-8ca467101ad3,2025-12-04T03:00:00.000Z,PANVEL MATRIZ     04/05,62.91,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_b003b309-57c9-4388-9b4d-0eb13dd02c0e,2025-12-04T03:00:00.000Z,FARMACIA SAO JOAO 04/06,49.73,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_2a4c84c3-1f2f-4707-b3a5-57bfb161f663,2025-12-04T03:00:00.000Z,FARMACIA SAO JOAO 06/06,43.56,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_452a6a76-3559-4609-b8b3-f225d9d0f2bd,2025-12-04T03:00:00.000Z,FARMACIA SAO JOAO 06/06,45,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_2b671c6f-391c-40a9-a4ff-95146865cbaf,2025-12-04T03:00:00.000Z,FARMACIA SAO JOAO 06/06,25.97,BRL,DEBIT,PENDING,Pharmacy,18020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_67142ee3-3eb1-44ed-89ba-1d506f2c4402,2025-12-04T03:00:00.000Z,MP *BISSOLICASAECO06/12,40.55,BRL,DEBIT,PENDING,Houseware,17030000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_4c2ef025-f6d4-46bb-a39d-02fad8cf9977,2025-12-04T03:00:00.000Z,MP *BESTSHOPMARKET07/07,14.66,BRL,DEBIT,PENDING,Electronics,08020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_5e65d0c4-0917-4c1e-9db2-367647630147,2025-12-04T03:00:00.000Z,MERCADOLIVRE*ANTAR08/12,51.06,BRL,DEBIT,PENDING,Shopping,08000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_01ad52c0-dbe9-4f30-8011-7a7538f45670,2025-12-04T03:00:00.000Z,MERCADOLIVRE*EBAZA08/10,55.08,BRL,DEBIT,PENDING,Shopping,08000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_d7300a43-0f3b-4a42-a98f-77b6c5711ca2,2025-12-04T03:00:00.000Z,MERCADOLIVRE*BRASI08/10,287.91,BRL,DEBIT,PENDING,Electronics,08020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_486998c2-c723-45b6-9f9c-1aba0edac598,2025-12-03T03:00:00.000Z,JUROS DE MORA,25.36,BRL,DEBIT,POSTED,Late payment and overdraft costs,02010000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_6fd0b24d-1203-490c-98a8-6ead5bde82ab,2025-12-03T03:00:00.000Z,ENCARGOS PIX,8.01,BRL,DEBIT,POSTED,Bank fees,16000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_67af2bd7-e6d4-43f4-85c5-e951a5a0f7e4,2025-12-03T03:00:00.000Z,ENCARGOS DE ATRASO,41.33,BRL,DEBIT,POSTED,Bank fees,16000000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_0341ae38-0894-4f4b-b681-404b9c9ba593,2025-12-03T03:00:00.000Z,JUROS DE FINANCIAMENTO,272.16,BRL,DEBIT,POSTED,Interests charged,02020000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_25a21266-64cc-4d5c-b5f9-18fa7b8e8ba7,2025-12-03T03:00:00.000Z,MULTA POR ATRASO,217.84,BRL,DEBIT,POSTED,Late payment and overdraft costs,02010000,acc_8ba81f5c-ca7d-4ff2-8f70-b91d285ab880,PERSON MULTIPLO BLACK PONTOS,CREDIT,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_4488a7fe-b0db-455d-81c2-590d073b54b9,2025-12-03T03:00:00.000Z,Fatura Cart√£o Visa DEB FATURA- CARTAO V,-4439.58,BRL,DEBIT,PENDING,Credit card payment,05100000,acc_2aa6908c-eefc-4efc-a104-0348a9e771ef,CONFED¬†NACIONAL¬†DAS¬†COOPERATIVAS¬†CENTRAIS¬†UNICRED¬†LTDA¬†-¬†UNICRED¬†DO¬†BRASIL,BANK,conn_e2959330-db28-477f-8c7a-d3b4ff035626,663,Unicred
txn_2b9414dd-1155-4156-8a57-312388b77646,2025-12-03T02:59:00.000Z,IOF,-0.38,BRL,DEBIT,POSTED,Tax on financial operations,15030000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_2f37fd53-ad9f-4852-a165-38058efdea76,2025-12-02T20:01:16.006Z,PIX QRS PANVEL FARM02/12,-509.1,BRL,DEBIT,POSTED,Pharmacy,18020000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_83430082-eade-4874-b8a2-6ed08b7dafc6,2025-12-02T19:58:42.062Z,PIX TRANSF GOWD IN02/12,401.5,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_02fceaec-520b-42a9-9b9b-9e2cbd156533,2025-12-02T16:00:03.090Z,PIX QRS EBANX02/12,-28.74,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_660b8988-63fa-4a39-8b6e-afd9f0a3b305,2025-12-02T15:45:43.029Z,PIX QRS Gowd Instit02/12,-550,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_51efb6e5-5cab-42cd-bef4-5b1e22318640,2025-12-02T13:54:44.047Z,PAY IFD E 02/12,-55.88,BRL,DEBIT,POSTED,Food delivery,11020000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_19415bfd-18c4-4a48-8801-d08ef47f22eb,2025-12-02T13:52:24.030Z,PAY IFD I 02/12,-5.97,BRL,DEBIT,POSTED,Food delivery,11020000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_425a57a8-bf08-4035-9a5e-ed7a5d38e8a9,2025-12-02T13:47:52.043Z,PIX TRANSF ZIPPI S02/12,750,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_4d6843c9-d031-48c1-be11-fc990a54f280,2025-12-01T20:44:44.034Z,PIX QRS Gowd Instit01/12,-500,BRL,DEBIT,POSTED,Services,07000000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_045da67b-669e-4982-9af7-2c8bd21cd9ad,2025-12-01T20:34:26.091Z,PIX TRANSF MARILIS01/12,500,BRL,CREDIT,POSTED,Transfer - PIX,05070000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
txn_3e16eb39-d3d2-43f0-87ab-d83c3081b68c,2025-12-01T09:25:36.130Z,Enviado - Pix,-32,BRL,DEBIT,POSTED,Transfer - PIX,05070000,acc_7d8f43fb-6760-4966-b5cc-bf4633ab91eb,RecargaPay,BANK,conn_5e9b45de-7c51-4f5f-9b32-e8407b38c7c8,767,RecargaPay
txn_9934abcd-87ee-4e78-8c6b-abadecf516e7,2025-12-01T09:20:43.536Z,INT MC BLACK,-12,BRL,DEBIT,POSTED,Credit card payment,05100000,acc_9fee2c5d-742d-4d7b-a823-02b68d195e91,itau,BANK,conn_162a48de-d656-4a8c-a486-18c74791fe67,601,Ita√∫
`;

        function showCSVModal() {
            document.getElementById('csv-modal').style.display = 'flex';
        }

        function closeCSVModal() {
            document.getElementById('csv-modal').style.display = 'none';
        }

        function processCSV(inputText) {
            // Allows passing text directly (e.g. from injected data) or reading from textarea
            let rawText = inputText;
            if (typeof rawText !== 'string') {
                rawText = document.getElementById('csv-input').value;
            }

            if (!rawText.trim()) {
                console.error("Empty CSV input");
                return;
            }

            eventLog = [];

            // STATS FOR FANCY CHARTS
            const flowStats = new Map(); // Key: "Source|Target", Value: Amount
            const catStats = new Map();  // Key: "Category", Value: Amount
            const bankStats = new Map(); // Key: "Bank", Value: Amount
            const lines = rawText.trim().split('\n');
            let successCount = 0;
            let errorLog = [];

            // Detect format based on header (insensitive check)
            const header = lines[0].toLowerCase();
            const hasTxnId = header.includes('transactionid');
            const hasDate = header.includes('date');

            // Determine column indices
            let colDate = 0;
            let colDesc = 1;
            let colAmt = -1; // Auto-detect
            let colType = -1;
            let colAccount = -1;
            let colCategory = -1;

            if (hasTxnId && hasDate) {
                // User Format: TransId(0), Date(1), Desc(2), Amt(3), Curr(4), Type(5), Status(6), Category(7)... Account(10)
                colDate = 1;
                colDesc = 2;
                colAmt = 3;
                colType = 5;
                colCategory = 7;
                colAccount = 10;
                console.log("Detected Custom Format (15 cols) with Categories");
            }

            // 1. PRE-SCAN: Find Date Range for Filtering (Last 3 Months)
            let maxTime = 0;
            // Temporary array to store parsed lines before filtering
            const parsedLines = [];
            const processedIds = new Set(); // For deduplication

            lines.forEach((line, idx) => {
                if (!line.trim() || idx === 0) return;

                // Quick parse date
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const dateStr = parts[colDate];
                if (!dateStr) return;

                const ts = new Date(dateStr).getTime();
                if (!isNaN(ts)) {
                    if (ts > maxTime) maxTime = ts;
                    parsedLines.push({ line, idx, ts, parts });
                }
            });

            const cutoffTime = maxTime - (1000 * 60 * 60 * 24 * 180); // 180 Days ago (6 months)
            console.log(`Date Range: ${new Date(cutoffTime).toLocaleDateString()} to ${new Date(maxTime).toLocaleDateString()}`);

            parsedLines.forEach(item => {
                const { line, idx, ts: timestamp, parts } = item;

                // FILTER: Only last 3 months
                if (timestamp < cutoffTime) return;

                // ID Check for Deduplication
                const txnId = parts[0] || `auto_${idx}`;
                if (processedIds.has(txnId)) {
                    // console.log(`Duplicate skipped: ${txnId}`);
                    return;
                }
                processedIds.add(txnId);

                // Robust CSV Splitter (handles quotes) - parts are already available from pre-scan
                // const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // No longer needed here

                // Fallback amount detection (look for number in last cols)
                if (colAmt === -1) {
                    for (let i = parts.length - 1; i >= 0; i--) {
                        if (!isNaN(parseFloat(parts[i].replace(/[^0-9.-]/g, '')))) {
                            colAmt = i;
                            break;
                        }
                    }
                }

                // let dateStr = parts[colDate]; // No longer needed, timestamp is available
                let desc = parts[colDesc];
                let amountPart = parts[colAmt];
                let type = colType > -1 ? parts[colType] : ''; // (e.g. Food, Transport). Fallback to Description.

                if (!amountPart) {
                    // errorLog.push(`Line ${idx}: Missing Amount`);
                    return;
                }

                const amount = parseFloat(amountPart.replace(/[^0-9.-]/g, ''));
                if (isNaN(amount)) {
                    // errorLog.push(`Line ${idx}: Invalid Amount`);
                    return;
                }

                // NODE LOGIC:
                // Wallet = "Account Name" (e.g. Itau, RecargaPay)
                // Activity = "Category" (e.g. Food, Transport). Fallback to Description.

                let walletNode = (colAccount > -1 && parts[colAccount]) ? parts[colAccount] : "My Wallet";
                let categoryNode = (colCategory > -1 && parts[colCategory]) ? parts[colCategory] : "";

                // Fallback if category missing
                if (!categoryNode) {
                    categoryNode = desc ? desc.replace(/"/g, '').trim() : "Unknown";
                }

                // Clean-up
                // Truncate if too long (e.g. detailed descriptions)
                // Remove special chars like quotes or *
                const clean = (str) => str.replace(/["*]/g, '').trim();

                walletNode = clean(walletNode);
                categoryNode = clean(categoryNode);

                if (categoryNode.length > 22) categoryNode = categoryNode.substring(0, 20) + '...';

                // Determine Direction based on Amount
                // Expense (< 0): Wallet -> Category
                // Income (> 0): Category -> Wallet
                let isExpense = amount < 0;

                // Color coding
                const colorExpense = '#ff4444'; // Red edge
                const colorIncome = '#00cc00';  // Green edge

                /* 
                 * GRAPH MODEL:
                 * Case ID = Transaction ID (Single instance)
                 * Step 1: Source
                 * Step 2: Destination
                 * Timestamp separation: 1 second (so they flow L->R)
                 */

                // For simplicity, we'll use a dummy caseId and timestamp for now
                // In a real scenario, you'd extract these from the CSV or generate them meaningfully.
                const caseId = txnId; // Use real ID for debugging
                // const timestamp = new Date(dateStr).getTime(); // Already available as 'timestamp' from item

                const VISUAL_DURATION = 1000 * 60 * 60 * 12; // 12 Hours (Ensures visibility)

                if (isExpense) {
                    // Money leaves Wallet -> Goes to Category
                    eventLog.push({ caseId, activity: walletNode, timestamp: timestamp, color: colorExpense });
                    eventLog.push({ caseId, activity: categoryNode, timestamp: timestamp + VISUAL_DURATION, color: colorExpense });
                } else {
                    // Money comes from Category -> Into Wallet
                    eventLog.push({ caseId, activity: categoryNode, timestamp: timestamp, color: colorIncome });
                    eventLog.push({ caseId, activity: walletNode, timestamp: timestamp + VISUAL_DURATION, color: colorIncome });
                }

                // AGGREGATE STATS (For Sankey/Sunburst)
                // We want: Source -> Target (Amount)
                // Expense: Wallet -> Category
                // Income: Category -> Wallet
                const flowKey = isExpense ? `${walletNode}|${categoryNode}` : `${categoryNode}|${walletNode}`;
                const absAmount = Math.abs(amount);

                flowStats.set(flowKey, (flowStats.get(flowKey) || 0) + absAmount);

                if (isExpense) {
                    // For Sunburst: Bank -> Category
                    if (!catStats.has(walletNode)) catStats.set(walletNode, new Map());
                    const bankCats = catStats.get(walletNode);
                    bankCats.set(categoryNode, (bankCats.get(categoryNode) || 0) + absAmount);
                }

                successCount++;
            });

            console.log(`Parsed ${successCount} transactions (Last 3 Months)`);

            // BUILD ECHARTS DATA

            // 1. SANKEY (with Cycle Removal)
            // Financial data has cycles (A‚ÜíB and B‚ÜíA), but Sankey needs DAG
            // Solution: Aggregate bidirectional flows into NET flow (dominant direction only)

            const sankeyNodes = new Set();
            const flowPairs = new Map(); // Track bidirectional flows

            // Step 1: Aggregate flows by node pairs (ignoring direction)
            flowStats.forEach((val, key) => {
                const [src, tgt] = key.split('|');
                const pairKey = [src, tgt].sort().join('|'); // Normalized key

                if (!flowPairs.has(pairKey)) {
                    flowPairs.set(pairKey, { forward: 0, backward: 0, nodes: [src, tgt].sort() });
                }

                const pair = flowPairs.get(pairKey);
                const [nodeA, nodeB] = pair.nodes;

                // Determine which direction this flow goes
                if (src === nodeA && tgt === nodeB) {
                    pair.forward += val;
                } else {
                    pair.backward += val;
                }
            });

            // Step 2: Create NET flows (only dominant direction)
            const sankeyLinks = [];
            flowPairs.forEach((pair) => {
                const [nodeA, nodeB] = pair.nodes;
                const netValue = pair.forward - pair.backward;

                if (Math.abs(netValue) > 0.01) { // Ignore tiny/zero flows
                    if (netValue > 0) {
                        // Net flow: A ‚Üí B
                        sankeyLinks.push({ source: nodeA, target: nodeB, value: Math.abs(netValue) });
                        sankeyNodes.add(nodeA);
                        sankeyNodes.add(nodeB);
                    } else {
                        // Net flow: B ‚Üí A
                        sankeyLinks.push({ source: nodeB, target: nodeA, value: Math.abs(netValue) });
                        sankeyNodes.add(nodeA);
                        sankeyNodes.add(nodeB);
                    }
                }
            });

            window.sankeyData = {
                nodes: Array.from(sankeyNodes).map(n => ({ name: n })),
                links: sankeyLinks
            };

            // 2. SUNBURST (Bank -> Category)
            const sunburstChildren = [];
            catStats.forEach((catsMap, bankName) => {
                const children = [];
                catsMap.forEach((val, catName) => {
                    children.push({ name: catName, value: val });
                });
                sunburstChildren.push({ name: bankName, children: children });
            });
            window.sunburstData = [{ name: 'Total Spending', children: sunburstChildren }];


            if (errorLog.length > 0) console.warn("Parse Errors:", errorLog);

            if (successCount > 0) {
                closeCSVModal();
                renderLog();
                mineGraph();
                const start = new Date(cutoffTime).toLocaleDateString();
                const end = new Date(maxTime).toLocaleDateString();
                document.querySelector('.tagline').innerText = `Visualizing ${successCount} txns (${start} - ${end})`;
            } else {
                alert(`Failed to parse CSV. \nSample Error: ${errorLog[0] || 'Unknown Error'}`);
            }
        }

        // Init - Load Injected Data by default
        window.addEventListener('load', () => {
            // 1. Fill Textarea so user can see data
            const ta = document.getElementById('csv-input');
            if (ta) ta.value = USER_DATA.trim();

            // 2. Auto-Process
            console.log("Auto-processing injected data...");
            setTimeout(() => processCSV(USER_DATA), 500); // Small delay to ensure DOM render
        });

        window.addEventListener('resize', fitGraph);

        // Global Error Handler for user visibility
        window.onerror = function (msg, url, line) {
            // Only alert if relevant to our script
            if (url.includes('process_mining_engine')) {
                alert("Script Error: " + msg + "\nLine: " + line);
            }
        };


    </script>
</body>

</html>