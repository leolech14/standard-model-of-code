#!/usr/bin/env python3
"""Inject SMoC relevance section from metadata into TXT file."""

import json
import sys
from pathlib import Path

REFS_DIR = Path(__file__).parent
METADATA_DIR = REFS_DIR / "metadata"
TXT_DIR = REFS_DIR / "txt"


def inject_relevance(ref_id: str) -> bool:
    """Inject SMoC relevance section into TXT file from metadata."""
    meta_file = METADATA_DIR / f"{ref_id}.json"
    txt_file = TXT_DIR / f"{ref_id}.txt"

    if not meta_file.exists():
        print(f"Error: {meta_file} not found")
        return False

    if not txt_file.exists():
        print(f"Error: {txt_file} not found")
        return False

    # Load metadata
    metadata = json.loads(meta_file.read_text())

    # Build relevance section
    relevance_lines = []
    relevance_lines.append("[SMoC RELEVANCE SECTION]")
    relevance_lines.append("")

    # Summary
    if metadata.get("summary") and metadata["summary"] != "[TO BE GENERATED BY LLM]":
        relevance_lines.append("## Summary")
        relevance_lines.append("")
        relevance_lines.append(metadata["summary"])
        relevance_lines.append("")

    # SMoC Relevance
    if metadata.get("smoc_relevance_summary") and metadata["smoc_relevance_summary"] != "[TO BE GENERATED BY LLM]":
        relevance_lines.append("## SMoC Relevance")
        relevance_lines.append("")
        relevance_lines.append(metadata["smoc_relevance_summary"])
        relevance_lines.append("")

    # Key Concepts
    if metadata.get("key_smoc_concepts"):
        relevance_lines.append("## Key SMoC Concepts")
        relevance_lines.append("")
        for concept in metadata["key_smoc_concepts"]:
            smoc_name = concept.get("smoc_concept", "").replace("_", " ").title()
            paper_name = concept.get("paper_concept", "")
            mapping = concept.get("mapping", "")
            strength = concept.get("strength", "")

            relevance_lines.append(f"### {smoc_name} ({strength})")
            relevance_lines.append(f"**Paper concept:** {paper_name}")
            relevance_lines.append(f"**Mapping:** {mapping}")

            quotes = concept.get("quotes_or_pages", [])
            if quotes:
                relevance_lines.append(f"**Key quotes:**")
                for quote in quotes:
                    relevance_lines.append(f"  - {quote}")
            relevance_lines.append("")

    # Important Equations
    if metadata.get("important_equations"):
        relevance_lines.append("## Important Equations")
        relevance_lines.append("")
        for eq in metadata["important_equations"]:
            relevance_lines.append(f"**Page {eq.get('page')}:** {eq.get('equation', '')}")
            relevance_lines.append(f"  {eq.get('description', '')}")
            if eq.get("smoc_mapping"):
                relevance_lines.append(f"  **SMoC:** {eq['smoc_mapping']}")
            relevance_lines.append("")

    # Cross-references
    if metadata.get("cross_references"):
        refs = ", ".join(metadata["cross_references"])
        relevance_lines.append(f"## Related References")
        relevance_lines.append(f"{refs}")
        relevance_lines.append("")

    # Gaps/Extensions
    if metadata.get("gaps_or_extensions") and metadata["gaps_or_extensions"] != "[TO BE GENERATED BY LLM]":
        relevance_lines.append("## Gaps & Extensions")
        relevance_lines.append("")
        relevance_lines.append(metadata["gaps_or_extensions"])
        relevance_lines.append("")

    relevance_lines.append("[END SMoC RELEVANCE]")

    relevance_section = "\n".join(relevance_lines)

    # Read TXT file
    txt_content = txt_file.read_text(encoding="utf-8")

    # Replace placeholder section
    if "[SMoC RELEVANCE SECTION - TO BE GENERATED]" in txt_content:
        # Replace the whole placeholder block
        import re
        pattern = r'\[SMoC RELEVANCE SECTION - TO BE GENERATED\].*?\[END SMoC RELEVANCE\]'
        new_content = re.sub(pattern, relevance_section, txt_content, flags=re.DOTALL)
    else:
        print(f"Warning: Placeholder not found in {txt_file.name}")
        return False

    # Save
    txt_file.write_text(new_content, encoding="utf-8")

    print(f"âœ“ Injected SMoC relevance into {txt_file.name}")
    return True


def main():
    if len(sys.argv) < 2:
        print("Usage: python3 inject_relevance.py <REF-ID>")
        return 1

    ref_id = sys.argv[1]
    success = inject_relevance(ref_id)
    return 0 if success else 1


if __name__ == "__main__":
    sys.exit(main())
