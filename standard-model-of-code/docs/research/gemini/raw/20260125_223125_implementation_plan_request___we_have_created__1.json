{
  "_meta": {
    "saved_at": "2026-01-25T22:31:25.628203",
    "source": "gemini",
    "model": "gemini-3-pro-preview",
    "query": "IMPLEMENTATION PLAN REQUEST:\n\nWe have created:\n1. Macro Registry (.agent/macros/) - Schema + MACRO-001 (Skeptical Audit)\n2. Decision Deck card (CARD-AUD-001)\n3. All documentation integrated\n\nWe need to implement:\n1. TRIGGER ENGINE - Watches for conditions, executes macros\n2. BARE MACRO SUPPORT - BARE can run production macros\n3. OPP AUTO-CREATION - Findings become actionable tasks\n\nCONTEXT:\n- BARE exists at .agent/tools/bare/ (partial implementation)\n- Task Registry at .agent/registry/ (working)\n- Workflow Registry at standard-model-of-code/src/core/registry/workflow_registry.py (working)\n- Post-commit hooks exist (.agent/hooks/post-commit)\n\nQUESTIONS:\n1. What is the minimal implementation to get macros auto-executing?\n2. How should trigger engine integrate with existing post-commit hooks?\n3. How should BARE be extended to support macros?\n4. What's the priority order for implementation?\n5. Estimate complexity (LOC, files) for each component.\n\nBe specific. Reference existing code paths. Provide implementation order.",
    "query_length": 1030,
    "checksum": "sha256:36816fc3b2b75ff31e2ef1ce3997233ed0919213ec8580f60049757a07d66230"
  },
  "response": {
    "content": "This is the **Implementation Plan for the Macro Automation System**.\n\nAs Chief Architect, I have analyzed the existing components (`.agent/macros`, `post-commit` hooks, `BARE`) and the missing links. We will establish a closed loop: **Code Change → Trigger → Macro Execution → Opportunity Creation**.\n\n---\n\n## 1. Minimal Implementation Plan\n\nTo get `MACRO-001` auto-executing with minimal friction, we will avoid complex event buses. We will use a **Direct Invocation Chain** via the existing git hooks.\n\n### The Pipeline\n1.  **Event:** Git Post-Commit.\n2.  **Dispatcher:** `trigger_engine.py` (New) - Scans changed files, matches Macro triggers.\n3.  **Executor:** `bare_macro_runner.py` (New module in BARE) - execution logic.\n4.  **Output:** `OPP-xxx.yaml` (Existing pattern) - created if macro detects issues.\n\n---\n\n## 2. Trigger Engine Integration\n\nThe Trigger Engine should not be a daemon for the MVP (to avoid process management complexity). It should be an **ephemeral CLI tool** invoked by the post-commit hook.\n\n**File:** `.agent/tools/trigger_engine.py`\n\n**Logic:**\n1.  **Context Detection:** Runs `git diff --name-only HEAD~1 HEAD` to see what changed.\n2.  **Registry Scan:** Loads all YAMLs from `.agent/macros/library/`.\n3.  **Match:** Checks `trigger` block in YAML.\n    *   If `trigger.type == \"on_change\"`, match changed files against `paths`.\n    *   If `trigger.type == \"always\"`, add to queue.\n4.  **Dispatch:** For every matching macro, invokes BARE:\n    ```bash\n    python .agent/tools/bare/cli.py run-macro MACRO-XXX --context \"commit_sha\"\n    ```\n\n**Hook Integration:**\nUpdate `.agent/hooks/post-commit` (or `.git/hooks/post-commit`):\n```bash\n#!/bin/bash\n# ... existing archive sync ...\n\necho \"[Trigger] Scanning for macros...\"\npython .agent/tools/trigger_engine.py --event post-commit\n```\n\n---\n\n## 3. Extending BARE for Macros\n\nBARE is currently a collection of scripts. We will add a structured `MacroExecutor` class.\n\n**File:** `.agent/tools/bare/macro_executor.py`\n\n**Capabilities:**\n1.  **Schema Parser:** Validates `MACRO-XXX.yaml` against `macro.schema.yaml`.\n2.  **Step Interpreter:** Iterates through `steps`.\n    *   *Shell Command:* Executes `subprocess.run`.\n    *   *Internal Tool:* Maps to python function (e.g., `survey.py`).\n3.  **Condition Checker:** Evaluates `success_criteria` (e.g., \"Did grep find matches?\").\n4.  **Artifact Manager:** Captures stdout/stderr/files generated.\n\n**File:** `.agent/tools/bare/opp_generator.py`\n1.  **Template Engine:** Takes a finding (e.g., \"Dead code in X\") and the Macro ID.\n2.  **Output:** Writes `.agent/registry/inbox/OPP-{timestamp}.yaml`.\n\n---\n\n## 4. Priority & Implementation Order\n\nWe must build from the \"Doer\" backward to the \"Trigger\".\n\n| Phase | Component | Description | Dependency |\n|-------|-----------|-------------|------------|\n| **1** | **Executor** | `bare/macro_executor.py` <br> Can run a macro given an ID. | Existing Registry |\n| **2** | **Reporter** | `bare/opp_generator.py` <br> Creates OPPs from executor results. | Phase 1 |\n| **3** | **Dispatcher** | `trigger_engine.py` <br> Selects macros based on git state. | Phase 1 |\n| **4** | **Wiring** | `post-commit` hook update. | Phase 3 |\n\n---\n\n## 5. Complexity Estimates\n\n### Component 1: `bare/macro_executor.py` (Phase 1)\n*   **Complexity:** Medium\n*   **LOC:** ~150-200\n*   **Key Methods:** `load_macro()`, `execute_step()`, `verify_criteria()`.\n*   **Files:** 1 new file, 1 update to `bare/cli.py`.\n\n### Component 2: `bare/opp_generator.py` (Phase 2)\n*   **Complexity:** Low\n*   **LOC:** ~80-100\n*   **Key Methods:** `create_opp_yaml()`, `calculate_confidence()`.\n*   **Files:** 1 new file.\n\n### Component 3: `trigger_engine.py` (Phase 3)\n*   **Complexity:** Low/Medium\n*   **LOC:** ~120\n*   **Key Methods:** `get_git_changes()`, `evaluate_trigger()`.\n*   **Dependencies:** `pyyaml`, `git`.\n*   **Files:** 1 new file.\n\n### Total Footprint\n*   **New Files:** 3\n*   **Modified Files:** 2 (`bare/cli.py`, `post-commit`)\n*   **Total LOC:** ~400 lines of Python.\n\n---\n\n## Topological Summary\n\nWe are creating a **Feedback Cycle** (Loop).\n\n```mermaid\ngraph TD\n    A[Git Commit] -->|triggers| B(Hook)\n    B -->|invokes| C{Trigger Engine}\n    C -->|reads| D[Macro Registry]\n    C -->|dispatches| E[BARE Executor]\n    E -->|runs| F[Analysis Tools]\n    F -->|produces| G[Findings]\n    G -->|if negative| H[OPP Generator]\n    H -->|writes| I[Inbox]\n    I -->|promoted to| J[Task Registry]\n    J -->|assigned to| K[Agent/Human]\n    K -->|fixes| A\n```\n\n## Immediate Action Items (Next Steps)\n\nSince you are in a session, execute **Phase 1 (The Executor)** immediately.\n\n1.  **Create `OPP-085: Implement BARE Macro Executor`**.\n2.  **Implement `.agent/tools/bare/macro_executor.py`**.\n    *   Hardcode support for `MACRO-001` structure first.\n3.  **Test manually:** `python .agent/tools/bare/cli.py run-macro MACRO-001`.\n\nThis validates the core logic before we automate the trigger.",
    "mode": "architect"
  }
}