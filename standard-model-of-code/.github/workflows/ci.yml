name: Collider CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    name: Health Check & Audit
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -e .
          pip install tree-sitter tree-sitter-python tree-sitter-javascript tree-sitter-typescript tree-sitter-rust pytest

      - name: Run Health Check
        run: |
          python - <<'PY'
          import os

          # NewmanSuite checks local dev environment (Ollama, etc.)
          # Skip in CI - Self-Analysis below is the real CI validation
          if os.environ.get("CI"):
              print("⏭️  Skipping NewmanSuite in CI (checks local dev environment)")
              raise SystemExit(0)

          from core.newman_suite import NewmanSuite

          results = NewmanSuite().run_all()
          failed = [r for r in results if r.status == "FAIL"]
          if failed:
              for r in failed:
                  print(f"FAIL: {r.component} - {r.error}")
              raise SystemExit(1)

          print("✅ Health check passed")
          PY

      - name: Self-Analysis
        run: |
          python cli.py analyze . --output ci_output 2>&1 | tail -20

      - name: Verify Coverage
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          output = Path("ci_output/unified_analysis.json")
          if not output.exists():
              print("❌ Output not found")
              raise SystemExit(1)

          data = json.loads(output.read_text())
          nodes = data.get("nodes", [])
          unknown = sum(1 for n in nodes if n.get("role") == "Unknown")
          total = len(nodes)

          if total == 0:
              print("❌ No nodes found")
              raise SystemExit(1)

          coverage = (total - unknown) / total * 100
          print(f"Coverage: {coverage:.1f}% ({total - unknown}/{total} nodes)")

          if coverage < 99.0:
              print("❌ Coverage below 99% threshold")
              raise SystemExit(1)

          print("✅ Coverage check passed")
          PY

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: collider-analysis
          path: |
            ci_output/
            proof_output.json
          retention-days: 7

  docstring-lint:
    name: Docstring Coverage
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking initially

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pydocstyle
        run: pip install pydocstyle

      - name: Run docstring check
        run: |
          pydocstyle src/core/ --convention=google --add-ignore=D100,D104,D105,D107 || true
          echo "Docstring check complete (non-blocking)"

  theory-coverage:
    name: Theory Completeness
    runs-on: ubuntu-latest
    needs: audit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: collider-analysis
          path: ci_output/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run theory coverage
        run: python scripts/theory_coverage.py ci_output/unified_analysis.json
