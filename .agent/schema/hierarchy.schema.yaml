# Task Hierarchy Schema
# Defines the nesting structure: ROADMAP > SPRINT > TASK/OPP > STEP
#
# Version: 1.0.0
# Updated: 2026-01-23

schema_version: "1.0.0"
kind: HierarchySchema

# ============================================================================
# LEVEL 0: ROADMAP (Strategic - Whole set of opportunities + tasks)
# ============================================================================
roadmap:
  id:
    type: string
    pattern: "^ROADMAP-[a-z0-9-]+$"
    description: "Unique roadmap identifier (e.g., ROADMAP-main, ROADMAP-viz-v2)"

  title:
    type: string
    max_length: 100
    description: "Roadmap title"

  description:
    type: string
    description: "Strategic vision and goals"

  # Branching support for parallel development
  branch:
    type: object
    properties:
      parent:
        type: string
        description: "Parent roadmap ID (null for main)"
      created_from:
        type: string
        description: "Commit/state this branch was created from"
      merge_target:
        type: string
        description: "Target roadmap to merge back into"

  # Phases within the roadmap
  phases:
    type: array
    items:
      type: object
      properties:
        id:
          type: string
          pattern: "^P[0-9]{1,2}$"
        name:
          type: string
        description:
          type: string
        status:
          type: enum
          values: [PLANNED, ACTIVE, COMPLETE, BLOCKED]
        sprints:
          type: array
          items:
            type: string
          description: "Sprint IDs in this phase"
        dependencies:
          type: array
          items:
            type: string
          description: "Phase IDs this depends on"

  # Metrics
  metrics:
    total_sprints:
      type: integer
    total_tasks:
      type: integer
    total_opps:
      type: integer
    completion_percentage:
      type: number

  # Timestamps
  created:
    type: datetime
  updated:
    type: datetime

# ============================================================================
# LEVEL 1: SPRINT (Tactical - Collective of tasks)
# ============================================================================
sprint:
  id:
    type: string
    pattern: "^SPRINT-[0-9]{3}$"
    description: "Sprint identifier (e.g., SPRINT-001)"

  title:
    type: string
    max_length: 80

  description:
    type: string

  # Parent reference
  roadmap_id:
    type: string
    description: "Parent roadmap ID"

  phase_id:
    type: string
    description: "Phase within roadmap"

  # Sprint status
  status:
    type: enum
    values:
      - PLANNING      # Defining scope
      - READY         # Scope defined, ready to start
      - EXECUTING     # Work in progress
      - REVIEW        # Sprint complete, reviewing results
      - COMPLETE      # Done
      - CANCELLED     # Abandoned

  # Definition of Done
  dod:
    type: array
    items:
      type: object
      properties:
        criterion:
          type: string
        status:
          type: enum
          values: [PENDING, DONE]
        evidence:
          type: string

  # Task/Opp references
  tasks:
    type: array
    items:
      type: string
    description: "TASK-XXX IDs in this sprint"

  opportunities:
    type: array
    items:
      type: string
    description: "OPP-XXX IDs being scoped in this sprint"

  # Timing
  start_date:
    type: date
  end_date:
    type: date

  # Metrics
  velocity:
    planned:
      type: integer
    completed:
      type: integer
    carried_over:
      type: integer

# ============================================================================
# LEVEL 2a: TASK (Execution - All gaps filled, ready to work)
# ============================================================================
task:
  id:
    type: string
    pattern: "^TASK-[0-9]{3}$"

  title:
    type: string
    max_length: 80

  description:
    type: string
    description: "Full context and acceptance criteria - NO GAPS"

  # Parent references
  sprint_id:
    type: string
    description: "Parent sprint (optional - can be unassigned)"

  promoted_from:
    type: string
    description: "OPP-XXX this was promoted from"

  # Status
  status:
    type: enum
    values:
      - READY         # Fully specified, claimable
      - EXECUTING     # Work in progress
      - BLOCKED       # Waiting on dependency
      - COMPLETE      # Done
      - ARCHIVED      # Closed

  # Risk level determines confidence threshold
  risk:
    type: enum
    values:
      - A             # Standard (90% threshold)
      - A+            # Important (95% threshold)
      - A++           # Critical (99% threshold)
    default: A

  # 4D Confidence
  confidence:
    factual:
      type: integer
      range: [0, 100]
    alignment:
      type: integer
      range: [0, 100]
    current:
      type: integer
      range: [0, 100]
    onwards:
      type: integer
      range: [0, 100]

  # Steps (LEVEL 3)
  steps:
    type: array
    items:
      $ref: "#/step"
    description: "Individual actions within this task"

  # Dependencies
  blocks:
    type: array
    items:
      type: string
  blocked_by:
    type: array
    items:
      type: string

  # Execution tracking
  claimed_by:
    type: string
    description: "Agent ID that claimed this task"
  claimed_at:
    type: datetime

  # Output
  output:
    files_created:
      type: array
      items:
        type: string
    files_modified:
      type: array
      items:
        type: string
    commits:
      type: array
      items:
        type: string

# ============================================================================
# LEVEL 2b: OPPORTUNITY (Discovery - Has gaps, needs refinement)
# ============================================================================
opportunity:
  id:
    type: string
    pattern: "^OPP-[0-9]{3}$"

  title:
    type: string
    max_length: 100

  description:
    type: string
    description: "What was discovered - MAY HAVE GAPS"

  # Source of discovery
  source:
    type: enum
    values:
      - BARE          # Auto-discovered by Background Auto-Refinement Engine
      - RESEARCH      # From analyze.py or Perplexity query
      - HUMAN         # Manual entry
      - WATCHER       # From file watcher
      - EXTERNAL      # From outside source (GitHub issue, etc.)
      - MIGRATION     # Imported from legacy registry
      - SOCRATIC      # From Holographic Socratic Layer audit

  # Gaps that need filling before promotion
  gaps:
    type: array
    items:
      type: object
      properties:
        question:
          type: string
          description: "What needs to be answered"
        status:
          type: enum
          values: [OPEN, RESOLVED]
        resolution:
          type: string
          description: "Answer when resolved"

  # Risk level (inherited when promoted to task)
  risk:
    type: enum
    values: [A, A+, A++]
    default: A

  # 4D Confidence (may be incomplete)
  confidence:
    factual:
      type: integer
      range: [0, 100]
    alignment:
      type: integer
      range: [0, 100]
    current:
      type: integer
      range: [0, 100]
    onwards:
      type: integer
      range: [0, 100]

  # Promotion tracking
  promoted_to:
    type: string
    description: "TASK-XXX if promoted"
  promoted_at:
    type: datetime

  # Urgency
  urgency:
    type: enum
    values: [LOW, MEDIUM, HIGH, CRITICAL]
    default: MEDIUM

# ============================================================================
# LEVEL 3: STEP (Atomic - Individual actions within a task)
# ============================================================================
step:
  id:
    type: string
    pattern: "^STEP-[0-9]{2}$"
    description: "Step within task (e.g., STEP-01)"

  action:
    type: string
    description: "What to do (imperative form)"

  status:
    type: enum
    values:
      - PENDING       # Not started
      - IN_PROGRESS   # Being worked on
      - DONE          # Completed
      - SKIPPED       # Intentionally skipped

  # Evidence of completion
  evidence:
    type: object
    properties:
      file:
        type: string
      lines:
        type: string
      commit:
        type: string
      note:
        type: string

  # Optional dependency within task
  depends_on:
    type: array
    items:
      type: string
    description: "STEP-XX IDs this depends on"

# ============================================================================
# DIRECTORY STRUCTURE
# ============================================================================
# .agent/
# ├── roadmaps/
# │   ├── ROADMAP-main.yaml           # Main development roadmap
# │   ├── ROADMAP-viz-v2.yaml         # Branch for visualization v2
# │   └── ROADMAP-experimental.yaml   # Experimental features
# ├── sprints/
# │   ├── SPRINT-001.yaml
# │   ├── SPRINT-002.yaml
# │   └── ...
# ├── registry/
# │   ├── inbox/                      # Opportunities
# │   │   ├── OPP-001.yaml
# │   │   └── ...
# │   ├── active/                     # Tasks
# │   │   ├── TASK-001.yaml
# │   │   └── ...
# │   └── archive/                    # Completed/rejected
# └── schema/
#     └── hierarchy.schema.yaml       # This file

# ============================================================================
# PROMOTION RULES
# ============================================================================
promotion_rules:
  opp_to_task:
    - All gaps must be RESOLVED
    - Confidence must meet risk threshold (A=90, A+=95, A++=99)
    - Description must include acceptance criteria
    - At least one step defined

  task_to_sprint:
    - Task must be in READY status
    - Sprint must be in PLANNING or READY status
    - No circular dependencies

  sprint_to_roadmap:
    - Sprint must have at least one task
    - Phase must exist in roadmap

# ============================================================================
# AUTO-PROMOTION THRESHOLDS
# ============================================================================
auto_promotion:
  enabled: true
  check_interval: "1h"  # Hourly on cloud

  thresholds:
    A: 90
    A+: 95
    A++: 99

  rules:
    - name: "Auto-promote high-confidence opportunities"
      condition: "confidence.min >= risk_threshold AND gaps.all_resolved"
      action: "promote_to_task"

    - name: "Auto-assign to sprint"
      condition: "task.status == READY AND active_sprint.status == EXECUTING"
      action: "add_to_sprint"
