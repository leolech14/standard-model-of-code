#!/bin/sh
# Post-commit automation chain
# AUTOPILOT: Self-running repository orchestrator with circuit breakers
#
# This hook delegates to autopilot.py which handles:
#   - Trigger Engine - macro execution on commit patterns
#   - Graceful degradation if systems fail
#   - Circuit breakers to prevent cascade failures
#
# NOTE: TDJ (Timestamp Daily Journal) is ON-DEMAND only, not post-commit.
#       Run manually: python context-management/tools/maintenance/tdj.py --scan
#
# To disable: .agent/tools/autopilot.py disable
# To check status: .agent/tools/autopilot.py status

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
AUTOPILOT="$REPO_ROOT/.agent/tools/autopilot.py"
PYTHON="$REPO_ROOT/.tools_venv/bin/python"

# Fallback to homebrew python3 if venv doesn't exist
if [ ! -f "$PYTHON" ]; then
    PYTHON="/opt/homebrew/bin/python3"
fi

# Run autopilot in post-commit mode (lightweight, ~100ms)
if [ -f "$AUTOPILOT" ]; then
    "$PYTHON" "$AUTOPILOT" post-commit --safe 2>/dev/null
    exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "[autopilot] Warning: post-commit automation returned $exit_code"
    fi
else
    echo "[autopilot] Warning: autopilot.py not found at $AUTOPILOT"
fi

# Legacy fallbacks (run if autopilot fails or is disabled)
# These are kept for backwards compatibility but autopilot handles them better

# Mirror to GCS (only if autopilot didn't run it)
if [ ! -f "$REPO_ROOT/.agent/state/autopilot_state.yaml" ]; then
    "$PYTHON" "$REPO_ROOT/context-management/tools/archive/archive.py" mirror 2>/dev/null || true
fi
